{% extends "base.html" %}
{% block title %}Wind Monitor Â· {% if lang=='da' %}Oversigt{% else %}Dashboard{% endif %}{% endblock %}

{% block head_extra %}
<script>
  window.GOOGLE_MAPS_KEY = "{{ google_maps_key }}";
</script>
{% endblock %}

{% block content %}
<!-- â”€â”€ KPI Summary Strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="kpiStrip" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Total effekt{% else %}Total Output{% endif %}</span>
    <span id="kpiPower" class="text-2xl font-bold text-sky-400">â€”</span>
    <span class="text-xs text-slate-500">MW</span>
  </div>
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Gns. vindhastighed{% else %}Avg Wind Speed{% endif %}</span>
    <span id="kpiWind" class="text-2xl font-bold text-emerald-400">â€”</span>
    <span class="text-xs text-slate-500">m/s</span>
  </div>
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Operationelle{% else %}Operational{% endif %}</span>
    <span id="kpiOp" class="text-2xl font-bold text-green-400">â€”</span>
    <span class="text-xs text-slate-500">/ 16 {% if lang=='da' %}mÃ¸ller{% else %}turbines{% endif %}</span>
  </div>
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Aktive advarsler{% else %}Active Alerts{% endif %}</span>
    <span id="kpiAlerts" class="text-2xl font-bold text-amber-400">â€”</span>
    <span class="text-xs text-slate-500">{% if lang=='da' %}hÃ¦ndelser{% else %}events{% endif %}</span>
  </div>
</div>

<!-- â”€â”€ Main Grid: Map + Fleet Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-4">

  <!-- Map (3 cols) -->
  <div class="lg:col-span-3 card p-0 overflow-hidden" style="height:460px;">
    <div class="px-4 pt-3 pb-2 flex items-center justify-between border-b border-slate-700">
      <h2 class="font-semibold text-white text-sm">
        {% if lang=='da' %}Placering af mÃ¸llepark Â· Vestjylland{% else %}Farm Location Â· Western Jutland{% endif %}
      </h2>
      <span class="text-xs text-slate-500">Google Maps Â· Dark</span>
    </div>
    <div id="map" style="height:412px;"></div>
  </div>

  <!-- Fleet Status (2 cols) -->
  <div class="lg:col-span-2 card flex flex-col overflow-hidden" style="height:460px;">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 flex items-center justify-between">
      <h2 class="font-semibold text-white text-sm">
        {% if lang=='da' %}MÃ¸llestatus{% else %}Turbine Status{% endif %}
      </h2>
      <div class="flex gap-2 text-xs">
        <button onclick="filterFleet('all')"      id="btn-all"     class="fleet-filter px-2 py-0.5 rounded bg-sky-700 text-white">{% if lang=='da' %}Alle{% else %}All{% endif %}</button>
        <button onclick="filterFleet('warning')"  id="btn-warning" class="fleet-filter px-2 py-0.5 rounded text-slate-400 hover:text-white">âš </button>
        <button onclick="filterFleet('fault')"    id="btn-fault"   class="fleet-filter px-2 py-0.5 rounded text-slate-400 hover:text-white">âœ—</button>
      </div>
    </div>
    <div id="fleetList" class="flex-1 overflow-y-auto divide-y divide-slate-800">
      <!-- populated by JS -->
      <div class="flex items-center justify-center h-full text-slate-500 text-sm">
        {% if lang=='da' %}IndlÃ¦ser data...{% else %}Loading data...{% endif %}
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Fleet Power Chart + Recent Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
  <!-- Fleet Power Chart -->
  <div class="lg:col-span-2 card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-white text-sm" id="fleetPowerTitle">
        {% if lang=='da' %}Samlet flÃ¥deproduktion Â· Seneste 48 timer{% else %}Total Fleet Output Â· Last 48 hours{% endif %}
      </h2>
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500" id="fleetPowerUpdated"></span>
        <button onclick="loadFleetPower('48h')" id="btn-48h"
          class="power-range text-xs px-2 py-0.5 rounded bg-sky-700 text-white">
          48h
        </button>
        <button onclick="loadFleetPower('7d')" id="btn-7d"
          class="power-range text-xs px-2 py-0.5 rounded text-slate-400 hover:text-white">
          7d
        </button>
      </div>
    </div>
    <div style="height:200px;">
      <canvas id="fleetPowerChart"></canvas>
    </div>
  </div>

  <!-- Recent Events -->
  <div class="card p-0 overflow-hidden">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 flex items-center justify-between">
      <h2 class="font-semibold text-white text-sm">
        {% if lang=='da' %}Seneste hÃ¦ndelser{% else %}Recent Events{% endif %}
      </h2>
      <span class="text-xs text-sky-400 cursor-pointer" onclick="loadEvents()">â†º</span>
    </div>
    <div id="eventsList" class="overflow-y-auto" style="max-height:240px;">
      <div class="flex items-center justify-center h-20 text-slate-500 text-sm">
        {% if lang=='da' %}IndlÃ¦ser...{% else %}Loading...{% endif %}
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ 16 Turbine Mini-Cards Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="mb-2">
  <h2 class="font-semibold text-slate-300 text-sm mb-3">
    {% if lang=='da' %}Alle 16 mÃ¸ller â€” detaljer{% else %}All 16 Turbines â€” Details{% endif %}
  </h2>
  <div id="turbineGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-8 gap-3">
    <!-- populated by JS -->
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const labels = {
  en: {
    operational:'Operational', warning:'Warning', fault:'Fault', offline:'Offline',
    wind:'Wind', power:'Power', rpm:'RPM', temp:'Temp', details:'Details',
    na: 'N/A', noData: 'No recent data',
  },
  da: {
    operational:'Operationel', warning:'Advarsel', fault:'Fejl', offline:'Offline',
    wind:'Vind', power:'Effekt', rpm:'Omdrejninger', temp:'Temp.', details:'Detaljer',
    na: 'N/A', noData: 'Ingen nylige data',
  }
};
const TXT = labels[LANG] || labels.en;
const STATUS_COL  = { operational:'#22c55e', warning:'#f59e0b', fault:'#ef4444', offline:'#6b7280' };
const TURBINE_SVG_SMALL = (col) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100.52 122.88" width="20" height="24" fill="${col}" style="display:inline-block;vertical-align:middle;flex-shrink:0"><path d="M36,58.09a7.11,7.11,0,0,1,.72.41l.12.07a6,6,0,0,1,1.43,1.36,5.84,5.84,0,0,1,.89,1.76v0a5.89,5.89,0,0,1,.23,2,7.59,7.59,0,0,1-.37,2l0,0a8,8,0,0,1-.41,1,9.31,9.31,0,0,1-.52.9A9.14,9.14,0,0,1,35,70.32,25.91,25.91,0,0,1,31.55,72c-9.5,3.9-18.87,8.6-28.37,12.4a3.14,3.14,0,0,1-1,.19h0a2.28,2.28,0,0,1-1.25-.32l-.37-.29a2,2,0,0,1-.34-.47l-.1-.24L0,83a1.78,1.78,0,0,1,0-.39v0a2.28,2.28,0,0,1,.47-1.31h0a4.09,4.09,0,0,1,.68-.72C9.51,73.62,18.3,67,26.81,60.23c.6-.48,1.22-.94,1.83-1.34a11.17,11.17,0,0,1,1.93-1l.13,0a6.55,6.55,0,0,1,2.11-.43,6.76,6.76,0,0,1,2.21.32l.1,0a7.33,7.33,0,0,1,.9.35ZM21.64,114.44H38.71l6.4-43.87a1.63,1.63,0,0,1,1.62-1.49h6a1.63,1.63,0,0,1,1.6,1.36l7.4,44H78.88a.89.89,0,0,1,.88.88V122a.89.89,0,0,1-.88.88H21.64a.88.88,0,0,1-.88-.88v-6.68a.88.88,0,0,1,.88-.88Zm32-66.07a9,9,0,0,1,2.87,1.91,8.73,8.73,0,0,1,2.57,6.1v.15a8.77,8.77,0,0,1-2.59,6.24,8.69,8.69,0,0,1-2.87,1.91A8.8,8.8,0,0,1,42.09,59.9a8.84,8.84,0,0,1,0-6.75A8.8,8.8,0,0,1,44,50.28h0a9.15,9.15,0,0,1,2.87-1.9,8.81,8.81,0,0,1,6.74,0Zm0-4.58a5.59,5.59,0,0,1-.8.45,5.82,5.82,0,0,1-1.94.54A5.54,5.54,0,0,1,49,44.63l-.09,0a6.23,6.23,0,0,1-1.8-.83,6.67,6.67,0,0,1-1.39-1.23l-.11-.12a7.71,7.71,0,0,1-.59-.81c-.17-.28-.34-.58-.49-.89l0,0c-1.2-2.54-.8-5.17-.4-7.85,1.8-10,2.25-20.76,4.06-30.76a3.45,3.45,0,0,1,.32-.88l0-.07a2.42,2.42,0,0,1,.85-.86l.06,0a1.69,1.69,0,0,1,.5-.18,1.75,1.75,0,0,1,.42,0A1.89,1.89,0,0,1,51,.13l.32.16a2.31,2.31,0,0,1,.88,1l.06.12a3.94,3.94,0,0,1,.28,1.09c1.76,10.18,2.74,21.75,4,32.13a2.2,2.2,0,0,1,0,.36h0c.08.7.15,1.39.17,2.07a11,11,0,0,1-.13,2.25v.07a6.83,6.83,0,0,1-.72,2,6.51,6.51,0,0,1-1.52,1.83,7.06,7.06,0,0,1-.78.57Zm7,21a7,7,0,0,1,0-.92,5.83,5.83,0,0,1,.5-2,5.43,5.43,0,0,1,1-1.54l.09-.09a6.08,6.08,0,0,1,1.61-1.14,7.46,7.46,0,0,1,1.78-.6l.14,0a7.57,7.57,0,0,1,1-.11,8.14,8.14,0,0,1,1,0h.07a9.28,9.28,0,0,1,3.92,1.33A27.18,27.18,0,0,1,74.93,62c8.12,6.31,16.34,12.51,24.52,18.76l.14.12a3.78,3.78,0,0,1,.61.78,2.44,2.44,0,0,1,.32,1.15l0,.26,0,.17a1.89,1.89,0,0,1-.24.6,2.05,2.05,0,0,1-.39.44l-.14.1a1.75,1.75,0,0,1-.27.16,2.51,2.51,0,0,1-1.36.2,4,4,0,0,1-1-.26L67,71.84c-.7-.29-1.4-.61-2.07-1A11.37,11.37,0,0,1,63,69.63l-.05,0a6.48,6.48,0,0,1-2.22-3.83,6.12,6.12,0,0,1-.11-1Z"/></svg>`;

// â”€â”€ Load Fleet Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fleetData = [];
let mapInstance, markers = {};

async function loadFleet() {
  const r = await fetch('/api/fleet');
  fleetData = await r.json();
  renderKPIs();
  renderFleetList(fleetData);
  renderTurbineGrid(fleetData);
  renderMap(fleetData);
}

function renderKPIs() {
  const op  = fleetData.filter(t => t.status === 'operational');
  const totalKW = fleetData.reduce((s, t) => s + (t.latest?.power_kw || 0), 0);
  const avgWind = fleetData.reduce((s, t) => s + (t.latest?.wind_ms || 0), 0) / fleetData.length;
  const alerts  = fleetData.reduce((s, t) => s + t.open_events, 0);

  document.getElementById('kpiPower').textContent   = (totalKW / 1000).toFixed(1);
  document.getElementById('kpiWind').textContent    = avgWind.toFixed(1);
  document.getElementById('kpiOp').textContent      = op.length;
  document.getElementById('kpiAlerts').textContent  = alerts;
}

// â”€â”€ Fleet List (sidebar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentFilter = 'all';
function filterFleet(f) {
  currentFilter = f;
  document.querySelectorAll('.fleet-filter').forEach(b => b.className = 'fleet-filter px-2 py-0.5 rounded text-slate-400 hover:text-white');
  document.getElementById('btn-' + f).className = 'fleet-filter px-2 py-0.5 rounded bg-sky-700 text-white';
  renderFleetList(fleetData);
}

function renderFleetList(data) {
  const filtered = currentFilter === 'all' ? data : data.filter(t => t.status === currentFilter || (currentFilter === 'warning' && ['warning','fault','offline'].includes(t.status)));
  const el = document.getElementById('fleetList');
  if (!filtered.length) { el.innerHTML = `<div class="flex items-center justify-center h-20 text-slate-500 text-sm">${LANG==='da'?'Ingen mÃ¸ller':'No turbines'}</div>`; return; }
  el.innerHTML = filtered.map(t => {
    const pw  = t.latest?.power_kw != null ? (t.latest.power_kw/1000).toFixed(2) + ' MW' : TXT.na;
    const wd  = t.latest?.wind_ms  != null ? t.latest.wind_ms.toFixed(1)  + ' m/s' : TXT.na;
    return `<a href="/turbine/${t.id}" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-700/50 transition-colors cursor-pointer">
      <div class="flex items-center justify-center w-6">${TURBINE_SVG_SMALL(STATUS_COL[t.status] || '#6b7280')}</div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span class="font-semibold text-white text-sm">${t.name}</span>
          ${t.open_events > 0 ? `<span class="text-xs bg-red-900/60 text-red-300 px-1.5 py-0.5 rounded-full">${t.open_events}</span>` : ''}
        </div>
        <div class="text-xs text-slate-400">${t.make} Â· ${t.model}</div>
      </div>
      <div class="text-right text-xs text-slate-400">
        <div>${pw}</div>
        <div>${wd}</div>
      </div>
    </a>`;
  }).join('');
}

// â”€â”€ 16 Turbine Mini-Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTurbineGrid(data) {
  document.getElementById('turbineGrid').innerHTML = data.map(t => {
    const pw = t.latest?.power_kw != null ? (t.latest.power_kw/1000).toFixed(2) : 'â€”';
    const wd = t.latest?.wind_ms  != null ? t.latest.wind_ms.toFixed(1) : 'â€”';
    const rp = t.latest?.rpm      != null ? t.latest.rpm.toFixed(1) : 'â€”';
    const tp = t.latest?.bearing_temp != null ? t.latest.bearing_temp.toFixed(0) : 'â€”';
    const borderCol = {operational:'border-green-800', warning:'border-amber-700', fault:'border-red-800', offline:'border-slate-700'}[t.status] || 'border-slate-700';
    return `<a href="/turbine/${t.id}" class="card border ${borderCol} p-3 flex flex-col gap-2 hover:border-sky-600 transition-colors cursor-pointer no-underline">
      <div class="flex items-center justify-between">
        <span class="font-bold text-white text-sm">${t.name}</span>
        ${TURBINE_SVG_SMALL(STATUS_COL[t.status] || '#6b7280')}
      </div>
      <div class="text-xs text-slate-500">${t.make}</div>
      <div class="grid grid-cols-2 gap-1 text-xs mt-1">
        <div><span class="text-slate-500">${TXT.power}</span><br><span class="text-sky-300 font-semibold">${pw} MW</span></div>
        <div><span class="text-slate-500">${TXT.wind}</span><br><span class="text-emerald-300 font-semibold">${wd} m/s</span></div>
        <div><span class="text-slate-500">${TXT.rpm}</span><br><span class="text-purple-300">${rp}</span></div>
        <div><span class="text-slate-500">${TXT.temp}</span><br><span class="text-orange-300">${tp}Â°C</span></div>
      </div>
      ${t.open_events > 0 ? `<div class="text-xs text-amber-400 font-medium">âš  ${t.open_events} ${LANG==='da'?'advarsel(er)':'alert(s)'}</div>` : ''}
    </a>`;
  }).join('');
}

// â”€â”€ Google Maps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TURBINE_SVG_PATH = "M36,58.09a7.11,7.11,0,0,1,.72.41l.12.07a6,6,0,0,1,1.43,1.36,5.84,5.84,0,0,1,.89,1.76v0a5.89,5.89,0,0,1,.23,2,7.59,7.59,0,0,1-.37,2l0,0a8,8,0,0,1-.41,1,9.31,9.31,0,0,1-.52.9A9.14,9.14,0,0,1,35,70.32,25.91,25.91,0,0,1,31.55,72c-9.5,3.9-18.87,8.6-28.37,12.4a3.14,3.14,0,0,1-1,.19h0a2.28,2.28,0,0,1-1.25-.32l-.37-.29a2,2,0,0,1-.34-.47l-.1-.24L0,83a1.78,1.78,0,0,1,0-.39v0a2.28,2.28,0,0,1,.47-1.31h0a4.09,4.09,0,0,1,.68-.72C9.51,73.62,18.3,67,26.81,60.23c.6-.48,1.22-.94,1.83-1.34a11.17,11.17,0,0,1,1.93-1l.13,0a6.55,6.55,0,0,1,2.11-.43,6.76,6.76,0,0,1,2.21.32l.1,0a7.33,7.33,0,0,1,.9.35ZM21.64,114.44H38.71l6.4-43.87a1.63,1.63,0,0,1,1.62-1.49h6a1.63,1.63,0,0,1,1.6,1.36l7.4,44H78.88a.89.89,0,0,1,.88.88V122a.89.89,0,0,1-.88.88H21.64a.88.88,0,0,1-.88-.88v-6.68a.88.88,0,0,1,.88-.88Zm32-66.07a9,9,0,0,1,2.87,1.91,8.73,8.73,0,0,1,2.57,6.1v.15a8.77,8.77,0,0,1-2.59,6.24,8.69,8.69,0,0,1-2.87,1.91A8.8,8.8,0,0,1,42.09,59.9a8.84,8.84,0,0,1,0-6.75A8.8,8.8,0,0,1,44,50.28h0a9.15,9.15,0,0,1,2.87-1.9,8.81,8.81,0,0,1,6.74,0Zm0-4.58a5.59,5.59,0,0,1-.8.45,5.82,5.82,0,0,1-1.94.54A5.54,5.54,0,0,1,49,44.63l-.09,0a6.23,6.23,0,0,1-1.8-.83,6.67,6.67,0,0,1-1.39-1.23l-.11-.12a7.71,7.71,0,0,1-.59-.81c-.17-.28-.34-.58-.49-.89l0,0c-1.2-2.54-.8-5.17-.4-7.85,1.8-10,2.25-20.76,4.06-30.76a3.45,3.45,0,0,1,.32-.88l0-.07a2.42,2.42,0,0,1,.85-.86l.06,0a1.69,1.69,0,0,1,.5-.18,1.75,1.75,0,0,1,.42,0A1.89,1.89,0,0,1,51,.13l.32.16a2.31,2.31,0,0,1,.88,1l.06.12a3.94,3.94,0,0,1,.28,1.09c1.76,10.18,2.74,21.75,4,32.13a2.2,2.2,0,0,1,0,.36h0c.08.7.15,1.39.17,2.07a11,11,0,0,1-.13,2.25v.07a6.83,6.83,0,0,1-.72,2,6.51,6.51,0,0,1-1.52,1.83,7.06,7.06,0,0,1-.78.57Zm7,21a7,7,0,0,1,0-.92,5.83,5.83,0,0,1,.5-2,5.43,5.43,0,0,1,1-1.54l.09-.09a6.08,6.08,0,0,1,1.61-1.14,7.46,7.46,0,0,1,1.78-.6l.14,0a7.57,7.57,0,0,1,1-.11,8.14,8.14,0,0,1,1,0h.07a9.28,9.28,0,0,1,3.92,1.33A27.18,27.18,0,0,1,74.93,62c8.12,6.31,16.34,12.51,24.52,18.76l.14.12a3.78,3.78,0,0,1,.61.78,2.44,2.44,0,0,1,.32,1.15l0,.26,0,.17a1.89,1.89,0,0,1-.24.6,2.05,2.05,0,0,1-.39.44l-.14.1a1.75,1.75,0,0,1-.27.16,2.51,2.51,0,0,1-1.36.2,4,4,0,0,1-1-.26L67,71.84c-.7-.29-1.4-.61-2.07-1A11.37,11.37,0,0,1,63,69.63l-.05,0a6.48,6.48,0,0,1-2.22-3.83,6.12,6.12,0,0,1-.11-1Z";

function makeTurbineSvgEl(col) {
  const el = document.createElement('div');
  el.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100.52 122.88" width="30" height="37" fill="${col}"><path d="${TURBINE_SVG_PATH}"/></svg>`;
  el.style.cursor = 'pointer';
  return el;
}

let gmapsLoaded = false;
let pendingMapData = null;

// Auth failure handler â€” called by Google Maps if key is invalid/restricted
window.gm_authFailure = function() {
  console.error('[Maps] Auth failure â€” check API key and HTTP referrer restrictions');
  const el = document.getElementById('map');
  if (el) el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:13px;flex-direction:column;gap:8px"><span style="font-size:24px">ğŸ—ºï¸</span><span>Map unavailable â€” check Google Maps API key</span></div>';
};

async function renderMap(data) {
  pendingMapData = data;
  if (!gmapsLoaded) {
    gmapsLoaded = true;
    // Use importLibrary bootstrap pattern (no callback, no v=beta)
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;a.onerror=()=>n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a);d[q]=f}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
    ({key: window.GOOGLE_MAPS_KEY, v: "weekly"});
    _initFleetMap();
  } else if (mapInstance) {
    _placeMarkers(data);
  }
}

let AdvancedMarkerElement = null;

async function _initFleetMap() {
  try {
    const { Map } = await google.maps.importLibrary('maps');
    const markerLib = await google.maps.importLibrary('marker');
    AdvancedMarkerElement = markerLib.AdvancedMarkerElement;

    const data = pendingMapData || [];
    if (!data.length) return;

    const avgLat = data.reduce((s,t) => s + t.lat, 0) / data.length;
    const avgLng = data.reduce((s,t) => s + t.lng, 0) / data.length;

    mapInstance = new Map(document.getElementById('map'), {
      center: { lat: avgLat, lng: avgLng },
      zoom: 12,
      mapId: 'DEMO_MAP_ID',
      colorScheme: 'DARK',
      mapTypeId: 'roadmap',
      zoomControl: true,
      streetViewControl: false,
      mapTypeControl: false,
      fullscreenControl: false,
    });

    _placeMarkers(data);
  } catch(err) {
    console.error('[Maps] Init failed:', err);
    const el = document.getElementById('map');
    if (el) el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:13px;flex-direction:column;gap:8px"><span style="font-size:24px">ğŸ—ºï¸</span><span>Map unavailable</span></div>';
  }
}

function _placeMarkers(data) {
  const colMap = { operational:'#22c55e', warning:'#f59e0b', fault:'#ef4444', offline:'#6b7280' };

  // Remove old markers
  Object.values(markers).forEach(m => m.map = null);
  markers = {};

  const bounds = new google.maps.LatLngBounds();

  data.forEach(t => {
    const col = colMap[t.status] || '#6b7280';
    const markerEl = makeTurbineSvgEl(col);

    // Wrap SVG + hover label in a container
    const markerWrapper = document.createElement('div');
    markerWrapper.style.cssText = 'position:relative;display:flex;flex-direction:column;align-items:center;cursor:pointer';
    markerWrapper.appendChild(markerEl);

    // Hover tooltip showing turbine name
    const tooltip = document.createElement('div');
    tooltip.textContent = t.name;
    tooltip.style.cssText = 'position:absolute;bottom:40px;left:50%;transform:translateX(-50%);background:#0f172a;color:#e2e8f0;font-size:11px;font-weight:600;padding:3px 7px;border-radius:4px;white-space:nowrap;border:1px solid #334155;opacity:0;transition:opacity 0.15s;pointer-events:none;font-family:system-ui';
    markerWrapper.appendChild(tooltip);
    markerWrapper.addEventListener('mouseenter', () => tooltip.style.opacity = '1');
    markerWrapper.addEventListener('mouseleave', () => tooltip.style.opacity = '0');

    const marker = new AdvancedMarkerElement({
      map: mapInstance,
      position: { lat: t.lat, lng: t.lng },
      content: markerWrapper,
      title: t.name,
    });

    // Click navigates directly to turbine detail page
    marker.addListener('gmp-click', () => {
      window.location.href = `/turbine/${t.id}`;
    });

    markers[t.id] = marker;
    bounds.extend({ lat: t.lat, lng: t.lng });
  });

  if (data.length > 0) mapInstance.fitBounds(bounds, { padding: 40 });
}

// â”€â”€ Fleet Power Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let powerChart;
let currentPowerRange = '48h';

async function loadFleetPower(range) {
  range = range || currentPowerRange;
  currentPowerRange = range;

  // Update toggle buttons
  document.querySelectorAll('.power-range').forEach(b => {
    b.className = 'power-range text-xs px-2 py-0.5 rounded text-slate-400 hover:text-white';
  });
  const activeBtn = document.getElementById('btn-' + range);
  if (activeBtn) activeBtn.className = 'power-range text-xs px-2 py-0.5 rounded bg-sky-700 text-white';

  // Update chart title
  const titleEl = document.getElementById('fleetPowerTitle');
  if (titleEl) {
    titleEl.textContent = range === '7d'
      ? (LANG==='da' ? 'Samlet flÃ¥deproduktion Â· Seneste 7 dage' : 'Total Fleet Output Â· Last 7 days')
      : (LANG==='da' ? 'Samlet flÃ¥deproduktion Â· Seneste 48 timer' : 'Total Fleet Output Â· Last 48 hours');
  }

  const r = await fetch(`/api/fleet/power?range=${range}`);
  const d = await r.json();
  if (!d.length) return;

  const timeUnit = range === '7d' ? 'day' : 'hour';
  const displayFormats = range === '7d'
    ? { day: 'EEE d MMM', hour: 'HH:mm' }
    : { hour: 'HH:mm', day: 'd MMM' };

  const ctx = document.getElementById('fleetPowerChart').getContext('2d');
  if (powerChart) powerChart.destroy();

  powerChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: d.map(x => new Date(x.t)),
      datasets: [
        {
          label: LANG==='da' ? 'Total effekt (MW)' : 'Total Output (MW)',
          data: d.map(x => (x.total_kw/1000).toFixed(2)),
          backgroundColor: 'rgba(14,165,233,0.35)',
          borderColor: 'rgba(14,165,233,0.8)',
          borderWidth: 1,
          borderRadius: 2,
          yAxisID: 'y',
        },
        {
          label: LANG==='da' ? 'Gns. vind (m/s)' : 'Avg Wind (m/s)',
          data: d.map(x => x.avg_wind.toFixed(2)),
          type: 'line',
          borderColor: 'rgba(52,211,153,0.8)',
          backgroundColor: 'transparent',
          pointRadius: 0,
          borderWidth: 1.5,
          tension: 0.4,
          yAxisID: 'y2',
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color:'#94a3b8', font:{size:11}, usePointStyle:true, pointStyle:'circle', boxWidth:8, boxHeight:8, padding:16 }
        },
        tooltip: {
          backgroundColor:'rgba(15,23,42,0.95)', borderColor:'#334155', borderWidth:1,
          titleColor:'#e2e8f0', titleFont:{weight:'bold',size:12},
          bodyColor:'#94a3b8', bodyFont:{size:12},
          padding:12, boxWidth:10, boxHeight:10,
          usePointStyle:true, pointStyle:'circle', bodySpacing:6,
          callbacks: { labelPointStyle: () => ({ pointStyle:'circle', rotation:0 }) }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: timeUnit, displayFormats },
          grid: { color:'rgba(51,65,85,0.5)' },
          ticks: { color:'#64748b', maxTicksLimit: range==='7d' ? 7 : 12, font:{size:10} }
        },
        y:  { grid:{color:'rgba(51,65,85,0.5)'}, ticks:{color:'#64748b', font:{size:10}}, position:'left'  },
        y2: { grid:{display:false}, ticks:{color:'#34d399', font:{size:10}}, position:'right' },
      }
    }
  });
  document.getElementById('fleetPowerUpdated').textContent = new Date().toLocaleTimeString();
}

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEvents() {
  const r = await fetch('/api/events?limit=15');
  const events = await r.json();
  const el = document.getElementById('eventsList');
  if (!events.length) { el.innerHTML = `<div class="px-4 py-4 text-slate-500 text-sm">${LANG==='da'?'Ingen hÃ¦ndelser':'No events'}</div>`; return; }
  const sevCol = { critical:'text-red-400', fault:'text-red-300', warning:'text-amber-300', info:'text-sky-300' };
  const sevIcon = { critical:'ğŸ”´', fault:'ğŸ”´', warning:'ğŸŸ¡', info:'ğŸ”µ' };
  el.innerHTML = events.map(e => `
    <div class="px-4 py-2.5 border-b border-slate-800 hover:bg-slate-700/30 transition-colors">
      <div class="flex items-start gap-2">
        <span class="text-sm mt-0.5">${e.category==='AI Analysis' ? 'ğŸ¤–' : (sevIcon[e.severity]||'âšª')}</span>
        <div class="flex-1 min-w-0">
          <div class="text-xs font-semibold ${sevCol[e.severity]||'text-slate-300'}">${e.friendly_code || e.code} Â· ${e.turbine_id ? 'T-'+e.turbine_id : ''}</div>
          <div class="text-xs text-slate-300 mt-0.5 line-clamp-2">${e.message}</div>
          <div class="text-xs text-slate-600 mt-1">${new Date(e.ts).toLocaleString()}</div>
        </div>
      </div>
    </div>
  `).join('');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadFleet();
loadEvents();
loadFleetPower();

// Auto-refresh every 60 seconds
setInterval(() => { loadFleet(); loadEvents(); loadFleetPower(currentPowerRange); }, 60000);
</script>
{% endblock %}
