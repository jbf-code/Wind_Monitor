{% extends "base.html" %}
{% block title %}TurbineOS Â· {% if lang=='da' %}Oversigt{% else %}Dashboard{% endif %}{% endblock %}

{% block head_extra %}
<script>
  window.GOOGLE_MAPS_KEY = "{{ google_maps_key }}";
</script>
{% endblock %}

{% block content %}
<!-- â”€â”€ KPI Summary Strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="kpiStrip" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Total effekt{% else %}Total Output{% endif %}</span>
    <span id="kpiPower" class="text-2xl font-bold text-sky-400">â€”</span>
    <span class="text-xs text-slate-500">MW</span>
  </div>
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Gns. vindhastighed{% else %}Avg Wind Speed{% endif %}</span>
    <span id="kpiWind" class="text-2xl font-bold text-emerald-400">â€”</span>
    <span class="text-xs text-slate-500">m/s</span>
  </div>
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Operationelle{% else %}Operational{% endif %}</span>
    <span id="kpiOp" class="text-2xl font-bold text-green-400">â€”</span>
    <span class="text-xs text-slate-500">/ 16 {% if lang=='da' %}mÃ¸ller{% else %}turbines{% endif %}</span>
  </div>
  <div class="card p-4 flex flex-col gap-1">
    <span class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Aktive advarsler{% else %}Active Alerts{% endif %}</span>
    <span id="kpiAlerts" class="text-2xl font-bold text-amber-400">â€”</span>
    <span class="text-xs text-slate-500">{% if lang=='da' %}hÃ¦ndelser{% else %}events{% endif %}</span>
  </div>
</div>

<!-- â”€â”€ Main Grid: Map + Fleet Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-4">

  <!-- Map (3 cols) -->
  <div class="lg:col-span-3 card p-0 overflow-hidden" style="height:460px;">
    <div class="px-4 pt-3 pb-2 flex items-center justify-between border-b border-slate-700">
      <h2 class="font-semibold text-white text-sm">
        {% if lang=='da' %}Placering af mÃ¸llepark Â· Vestjylland{% else %}Farm Location Â· Western Jutland{% endif %}
      </h2>
      <span class="text-xs text-slate-500">Google Maps Â· Dark</span>
    </div>
    <div id="map" style="height:412px;"></div>
  </div>

  <!-- Fleet Status (2 cols) -->
  <div class="lg:col-span-2 card flex flex-col overflow-hidden" style="height:460px;">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 flex items-center justify-between">
      <h2 class="font-semibold text-white text-sm">
        {% if lang=='da' %}MÃ¸llestatus{% else %}Turbine Status{% endif %}
      </h2>
      <div class="flex gap-2 text-xs">
        <button onclick="filterFleet('all')"      id="btn-all"     class="fleet-filter px-2 py-0.5 rounded bg-sky-700 text-white">{% if lang=='da' %}Alle{% else %}All{% endif %}</button>
        <button onclick="filterFleet('warning')"  id="btn-warning" class="fleet-filter px-2 py-0.5 rounded text-slate-400 hover:text-white">âš </button>
        <button onclick="filterFleet('fault')"    id="btn-fault"   class="fleet-filter px-2 py-0.5 rounded text-slate-400 hover:text-white">âœ—</button>
      </div>
    </div>
    <div id="fleetList" class="flex-1 overflow-y-auto divide-y divide-slate-800">
      <!-- populated by JS -->
      <div class="flex items-center justify-center h-full text-slate-500 text-sm">
        {% if lang=='da' %}IndlÃ¦ser data...{% else %}Loading data...{% endif %}
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Fleet Power Chart + Recent Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
  <!-- Fleet Power Chart -->
  <div class="lg:col-span-2 card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-white text-sm" id="fleetPowerTitle">
        {% if lang=='da' %}Samlet flÃ¥deproduktion Â· Seneste 48 timer{% else %}Total Fleet Output Â· Last 48 hours{% endif %}
      </h2>
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500" id="fleetPowerUpdated"></span>
        <button onclick="loadFleetPower('48h')" id="btn-48h"
          class="power-range text-xs px-2 py-0.5 rounded bg-sky-700 text-white">
          48h
        </button>
        <button onclick="loadFleetPower('7d')" id="btn-7d"
          class="power-range text-xs px-2 py-0.5 rounded text-slate-400 hover:text-white">
          7d
        </button>
      </div>
    </div>
    <div style="height:200px;">
      <canvas id="fleetPowerChart"></canvas>
    </div>
  </div>

  <!-- Recent Events -->
  <div class="card p-0 overflow-hidden">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 flex items-center justify-between">
      <h2 class="font-semibold text-white text-sm">
        {% if lang=='da' %}Seneste hÃ¦ndelser{% else %}Recent Events{% endif %}
      </h2>
      <span class="text-xs text-sky-400 cursor-pointer" onclick="loadEvents()">â†º</span>
    </div>
    <div id="eventsList" class="overflow-y-auto" style="max-height:240px;">
      <div class="flex items-center justify-center h-20 text-slate-500 text-sm">
        {% if lang=='da' %}IndlÃ¦ser...{% else %}Loading...{% endif %}
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ 16 Turbine Mini-Cards Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="mb-2">
  <div class="flex items-center gap-3 mb-3">
    <h2 class="font-semibold text-slate-300 text-sm">
      {% if lang=='da' %}Alle 16 mÃ¸ller â€” detaljer{% else %}All 16 Turbines â€” Details{% endif %}
    </h2>
    <span id="sensorModeLabel" class="text-xs px-2 py-0.5 rounded-full font-medium"></span>
  </div>
  <div id="turbineGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-8 gap-3">
    <!-- populated by JS -->
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const labels = {
  en: {
    operational:'Operational', warning:'Warning', fault:'Fault', offline:'Offline',
    wind:'Wind', power:'Power', rpm:'RPM', temp:'Temp', details:'Details',
    na: 'N/A', noData: 'No recent data',
  },
  da: {
    operational:'Operationel', warning:'Advarsel', fault:'Fejl', offline:'Offline',
    wind:'Vind', power:'Effekt', rpm:'Omdrejninger', temp:'Temp.', details:'Detaljer',
    na: 'N/A', noData: 'Ingen nylige data',
  }
};
const TXT = labels[LANG] || labels.en;
const STATUS_COL  = { operational:'#22c55e', warning:'#f59e0b', fault:'#ef4444', offline:'#6b7280' };

// Three turbine blade orientations from the real turbine SVG assets.
// All share the same viewBox (2686.7 Ã— 1227.3) â€” we crop to the blade region.
const TURBINE_PATHS = [
  // Variant 1 â€” blade pointing up-right
  "M1162,719.5c-7.4-16.6-14.5-33.2-21.8-49.8-11.8-27.1-23.7-54.3-35.6-81.4-4.8-10.9-9.6-21.8-14.5-32.7-2.5-5.6-4.9-11.4-7.8-16.9-1.6-3.2-4.3-5.8-6.9-8.1-4.3-3.8-9-7.1-13.6-10.4-5.6-4-11.3-8-16.7-12.3-.3-.3-.7-.5-1-.8,2-2.1,2.3-4.8,2.3-7.6v-18.2c0-2.5,0-4.8-1.4-7.1-.3-.5-.7-1-1.1-1.4,7.2-9.9,13.7-20.5,20.3-30.9,3.5-5.6,7-11,10-16.9,9.2-18.6,18.9-36.9,28.5-55.3,12.9-25,25.9-49.9,38.8-74.9,4.5-8.7,9-17.3,13.4-26,1.2-2.3,2.3-4.5,3.5-6.8.2-.5.5-1,.7-1.5.4-.8.7-1.7,1-2.6.3-1,.5-1.4,0-1.5,0,0-.3,0-.5,0-.1,0-.2,0-.3,0-.5,0-1,0-1.4,0,0,0-.2,0-.1,0-.2,0-.4.1-.5.3-.9.8-1.5,1.8-2.2,2.7-10.6,14.7-21.5,29.2-32.3,43.8-17.6,23.8-35.2,47.7-52.7,71.5-7.1,9.6-14.1,19.3-21.1,28.9-3.6,5-7.4,10-10.7,15.2-1.9,3-2.8,6.6-3.6,10.1-1.2,5.6-1.6,11.3-2.2,17-.7,6.9-1.3,13.8-2.3,20.7-.2,1.2-.4,2.4-.6,3.6h-10.7c-2.1,0-4.3-.2-6.3.5-.7.2-1.5.6-2.2.9-.1,0-.3.2-.4.2-.6.3-1.1.7-1.6,1.1-1.3,1-2.4,2.2-3.1,3.6-1.1,2.1-.9,4.5-.9,6.8v2.5c-13.5-1.7-27.3-2-40.9-2.6-6.6-.3-13.1-.6-19.6-.2-20.7,1.3-41.4,2.1-62.1,3-28.1,1.3-56.2,2.5-84.2,3.8-9.7.4-19.5.9-29.2,1.4-2.6.1-5.1.3-7.7.4-.5,0-1.1,0-1.6.1-.9,0-1.8.2-2.7.4-1,.2-1.4.3-1.3.8,0,0,0,.3.2.4,0,0,0,.2.2.3.2.4.4.9.7,1.2,0,0,.1.1.1.1.1.1.3.3.5.3,1.1.4,2.3.4,3.5.5,18,1.9,36,4,54,6.1,29.4,3.3,58.8,6.6,88.3,9.8,11.9,1.3,23.7,2.6,35.6,3.8,6.1.6,12.3,1.4,18.5,1.7,3.6.2,7.1-.8,10.5-1.9,5.4-1.8,10.6-4.2,15.8-6.6,6.3-2.9,12.6-5.8,19-8.3.8-.3,1.6-.6,2.4-.9,0,3.8.5,7.5,3.4,10,2.1,1.9,4.7,2,7.4,2h0c-.1,8-.2,16-.3,24-.3,20.9-.6,41.8-.9,62.8-.4,29.1-.8,58.3-1.2,87.4-.4,32.7-.9,65.3-1.3,98-.4,31.5-.9,63-1.3,94.5-.4,25.7-.7,51.3-1.1,77-.2,15.1-.4,30.2-.6,45.4,0,2.1,0,4.3,0,6.4,0,0,34.6,0,34.6,0,0,0-.2-17.3-.3-25.3-.3-20.9-.6-41.8-.9-62.8-.4-29.1-.8-58.3-1.2-87.4-.4-32.7-.9-65.3-1.3-98-.4-31.5-.9-63-1.3-94.5-.4-25.7-.7-51.3-1.1-77-.2-12.7-.3-25.4-.5-38.1,4.2,8.8,8.9,17.4,13.4,26,3.1,5.8,6,11.6,9.7,17.1,11.4,17.3,22.5,34.8,33.7,52.3,15.1,23.7,30.3,47.4,45.4,71.1,5.3,8.2,10.5,16.4,15.8,24.6,1.4,2.1,2.8,4.3,4.2,6.4.3.5.6.9.9,1.4.5.7,1.1,1.5,1.7,2.1.7.8.9,1.1,1.3.8,0,0,.2-.2.3-.4,0,0,.1-.2.2-.3.2-.4.6-.8.7-1.2,0,0,0-.2,0-.1,0-.2,0-.4,0-.6-.2-1.1-.8-2.2-1.3-3.3Z",
  // Variant 2 â€” blade pointing left
  "M661.1,623.3c0-.2-.1-.4-.3-.5-.8-.9-1.8-1.5-2.7-2.2-14.7-10.6-29.2-21.5-43.8-32.3-23.8-17.6-47.7-35.2-71.5-52.7-9.6-7.1-19.3-14.1-28.9-21.1-5-3.6-10-7.4-15.2-10.7-3-1.9-6.6-2.8-10.1-3.6-5.6-1.2-11.3-1.6-17-2.2-6.9-.7-13.8-1.3-20.7-2.3-1.2-.2-2.3-.4-3.5-.5v-14c0-2.5,0-4.8-1.4-7.1-1.8-2.9-5-4.1-8.2-4.1h-6c1.7-13.6,2.1-27.4,2.6-41,.3-6.6.6-13.1.2-19.6-1.3-20.7-2.1-41.4-3-62.1-1.3-28.1-2.5-56.2-3.8-84.2-.4-9.7-.9-19.5-1.4-29.2-.1-2.6-.3-5.1-.4-7.7,0-.5,0-1.1-.1-1.6,0-.9-.2-1.8-.4-2.7-.2-1-.3-1.4-.8-1.3,0,0-.3,0-.4.2,0,0-.2,0-.3.2-.4.2-.9.4-1.2.7,0,0-.1.1-.1.1-.1.1-.3.3-.3.5-.4,1.1-.4,2.3-.5,3.5-1.9,18-4,36-6.1,54-3.3,29.4-6.6,58.8-9.8,88.3-1.3,11.9-2.6,23.7-3.8,35.6-.6,6.1-1.4,12.3-1.7,18.5-.2,3.6.8,7.1,1.9,10.5,1.8,5.4,4.2,10.6,6.6,15.8,2.9,6.3,5.8,12.6,8.3,19,.4.9.7,1.8,1,2.6-1.6,0-3.2,0-4.7.5-.7.2-1.5.6-2.2.9-.1,0-.3.2-.4.2-.6.3-1.1.7-1.6,1.1-1.3,1-2.4,2.2-3.1,3.6-1.1,2.1-.9,4.5-.9,6.8v9.6c0,1.2,0,2.5-.1,3.8-12.8,5.4-25.2,12.1-37.5,18.6-5.8,3.1-11.6,6-17.1,9.7-17.3,11.4-34.8,22.5-52.3,33.7-23.7,15.1-47.4,30.3-71.1,45.4-8.2,5.3-16.4,10.5-24.6,15.8-2.1,1.4-4.3,2.8-6.4,4.2-.5.3-.9.6-1.4.9-.7.5-1.5,1.1-2.1,1.7-.8.7-1.1.9-.8,1.3,0,0,.2.2.4.3,0,0,.2.1.3.2.4.2.8.6,1.2.7,0,0,.2,0,.1,0,.2,0,.4,0,.6,0,1.1-.2,2.2-.8,3.3-1.3,16.6-7.4,33.2-14.5,49.8-21.8,27.1-11.8,54.3-23.7,81.4-35.6,10.9-4.8,21.8-9.6,32.7-14.5,5.6-2.5,11.4-4.9,16.9-7.8,3.2-1.6,5.8-4.3,8.1-6.9,3.8-4.3,7.1-9,10.4-13.6,4-5.6,8-11.3,12.3-16.7.1-.2.3-.4.4-.5,1.8.9,3.9,1.1,5.9,1.1h0c-.1,8-.2,16-.3,24-.3,20.9-.6,41.8-.9,62.8-.4,29.1-.8,58.3-1.2,87.4-.4,32.7-.9,65.3-1.3,98-.4,31.5-.9,63-1.3,94.5-.4,25.7-.7,51.3-1.1,77-.2,15.1-.4,30.2-.6,45.4,0,2.1,0,4.3,0,6.4,0,0,34.6,0,34.6,0,0,0-.2-17.3-.3-25.3-.3-20.9-.6-41.8-.9-62.8-.4-29.1-.8-58.3-1.2-87.4-.4-32.7-.9-65.3-1.3-98-.4-31.5-.9-63-1.3-94.5-.4-25.7-.7-51.3-1.1-77-.2-15.1-.4-30.2-.6-45.4,0-1.7,0-3.5,0-5.2.5,0,1-.2,1.4-.3,1.8-.4,3.5-1.3,5-2.3,10.3,7.6,21.4,14.4,32.2,21.2,5.6,3.5,11,7,16.9,10,18.6,9.2,36.9,18.9,55.3,28.5,25,12.9,49.9,25.9,74.9,38.8,8.7,4.5,17.3,9,26,13.4,2.3,1.2,4.5,2.3,6.8,3.5.5.2,1,.5,1.5.7.8.4,1.7.7,2.6,1,1,.3,1.4.5,1.5,0,0,0,0-.3,0-.5,0-.1,0-.2,0-.3,0-.5,0-1,0-1.4,0,0,0-.2,0-.1Z",
  // Variant 3 â€” blade pointing right
  "M2494.6,489.6c0,0,0-.2-.2-.3-.2-.4-.4-.9-.7-1.2,0,0-.1-.1-.1-.1-.1-.1-.3-.3-.5-.3-1.1-.4-2.3-.4-3.5-.5-18-1.9-36-4-54-6.1-29.4-3.3-58.8-6.6-88.3-9.8-11.9-1.3-23.7-2.6-35.6-3.8-6.1-.6-12.3-1.4-18.5-1.7-3.6-.2-7.1.8-10.5,1.9-5.4,1.8-10.6,4.2-15.8,6.6-6.3,2.9-12.6,5.8-19,8.3-.8.3-1.6.6-2.4.9v-2.3c0-2.5,0-4.8-1.4-7.1-1.8-2.9-5-4.1-8.2-4.1h-17.4c-5.3-12.7-12-24.9-18.3-37-3.1-5.8-6-11.6-9.7-17.1-11.4-17.3-22.5-34.8-33.7-52.3-15.1-23.7-30.3-47.4-45.4-71.1-5.3-8.2-10.5-16.4-15.8-24.6-1.4-2.1-2.8-4.3-4.2-6.4-.3-.5-.6-.9-.9-1.4-.5-.7-1.1-1.5-1.7-2.1-.7-.8-.9-1.1-1.3-.8,0,0-.2.2-.3.4,0,0-.1.2-.2.3-.2.4-.6.8-.7,1.2,0,0,0,.2,0,.1,0,.2,0,.4,0,.6.2,1.1.8,2.2,1.3,3.3,7.4,16.6,14.5,33.2,21.8,49.8,11.8,27.1,23.7,54.3,35.6,81.4,4.8,10.9,9.6,21.8,14.5,32.7,2.5,5.6,4.9,11.4,7.8,16.9,1.6,3.2,4.3,5.8,6.9,8.1,4.3,3.8,9,7.1,13.6,10.4,5.6,4,11.3,8,16.7,12.3.2.1.3.2.5.4-.3.4-.5.8-.7,1.2-1.1,2.1-.9,4.5-.9,6.8v9.6c0,5.3-1.3,12.3,3.1,16.3-7.5,10.2-14.2,21.2-21,31.8-3.5,5.6-7,11-10,16.9-9.2,18.6-18.9,36.9-28.5,55.3-12.9,25-25.9,49.9-38.8,74.9-4.5,8.7-9,17.3-13.4,26-1.2,2.3-2.3,4.5-3.5,6.8-.2.5-.5,1-.7,1.5-.4.8-.7,1.7-1,2.6-.3,1-.5,1.4,0,1.5,0,0,.3,0,.5,0,.1,0,.2,0,.3,0,.5,0,1,0,1.4,0,0,0,.2,0,.1,0,.2,0,.4-.1.5-.3.9-.8,1.5-1.8,2.2-2.7,10.6-14.7,21.5-29.2,32.3-43.8,17.6-23.8,35.2-47.7,52.7-71.5,7.1-9.6,14.1-19.3,21.1-28.9,3.6-5,7.4-10,10.7-15.2.8-1.2,1.4-2.5,1.9-3.8-.2,12.6-.3,25.3-.5,37.9-.4,29.1-.8,58.3-1.2,87.4-.4,32.7-.9,65.3-1.3,98-.4,31.5-.9,63-1.3,94.5-.4,25.7-.7,51.3-1.1,77-.2,15.1-.4,30.2-.6,45.4,0,2.1,0,4.3,0,6.4,0,0,34.6,0,34.6,0,0,0-.2-17.3-.3-25.3-.3-20.9-.6-41.8-.9-62.8-.4-29.1-.8-58.3-1.2-87.4-.4-32.7-.9-65.3-1.3-98-.4-31.5-.9-63-1.3-94.5-.4-25.7-.7-51.3-1.1-77-.2-15.1-.4-30.2-.6-45.4,0-1.7,0-3.5,0-5.2.5,0,1-.2,1.4-.3,2.5-.6,4.9-2,6.7-3.7,2.1-2.1,2.4-4.9,2.4-7.7v-2.3c13.5,1.7,27.2,2,40.7,2.5,6.6.3,13.1.6,19.6.2,20.7-1.3,41.4-2.1,62.1-3,28.1-1.3,56.2-2.5,84.2-3.8,9.7-.4,19.5-.9,29.2-1.4,2.6-.1,5.1-.3,7.7-.4.5,0,1.1,0,1.6-.1.9,0,1.8-.2,2.7-.4,1-.2,1.4-.3,1.3-.8,0,0,0-.3-.2-.4Z"
];

// viewBox regions that tightly contain each blade variant (x y w h)
// Each blade spans ~950 units tall Ã— ~340 wide in the 2686.7Ã—1227.3 canvas
const TURBINE_VIEWBOXES = [
  "840 265 340 955",   // Variant 1 â€” blade up-right
  "265 265 410 955",   // Variant 2 â€” blade left
  "2135 265 360 955",  // Variant 3 â€” blade right
];

// Pick variant by turbine id (deterministic, cycles through 3 shapes)
// viewBox is ~340Ã—955 â†’ aspect ratio â‰ˆ 1:2.8 â†’ at width=20, height=56
const TURBINE_SVG_SMALL = (col, tid=0) => {
  const v = (tid - 1 + 3) % 3;   // turbine ids typically 1-based; maps 1â†’0, 2â†’1, 3â†’2 etc.
  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${TURBINE_VIEWBOXES[v]}" width="20" height="56" fill="${col}" style="display:inline-block;vertical-align:middle;flex-shrink:0"><path d="${TURBINE_PATHS[v]}"/></svg>`;
};

// â”€â”€ Load Fleet Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fleetData = [];
let mapInstance, markers = {};

async function loadFleet() {
  const r = await fetch('/api/fleet');
  fleetData = await r.json();
  renderKPIs();
  renderFleetList(fleetData);
  renderTurbineGrid(fleetData);
  renderMap(fleetData);
}

function renderKPIs() {
  const op  = fleetData.filter(t => t.status === 'operational');
  const totalKW = fleetData.reduce((s, t) => s + (t.latest?.power_kw || 0), 0);
  const avgWind = fleetData.reduce((s, t) => s + (t.latest?.wind_ms || 0), 0) / fleetData.length;
  const alerts  = fleetData.reduce((s, t) => s + t.open_events, 0);

  document.getElementById('kpiPower').textContent   = (totalKW / 1000).toFixed(1);
  document.getElementById('kpiWind').textContent    = avgWind.toFixed(1);
  document.getElementById('kpiOp').textContent      = op.length;
  document.getElementById('kpiAlerts').textContent  = alerts;
}

// â”€â”€ Fleet List (sidebar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentFilter = 'all';
function filterFleet(f) {
  currentFilter = f;
  document.querySelectorAll('.fleet-filter').forEach(b => b.className = 'fleet-filter px-2 py-0.5 rounded text-slate-400 hover:text-white');
  document.getElementById('btn-' + f).className = 'fleet-filter px-2 py-0.5 rounded bg-sky-700 text-white';
  renderFleetList(fleetData);
}

function renderFleetList(data) {
  const filtered = currentFilter === 'all' ? data : data.filter(t => t.status === currentFilter || (currentFilter === 'warning' && ['warning','fault','offline'].includes(t.status)));
  const el = document.getElementById('fleetList');
  if (!filtered.length) { el.innerHTML = `<div class="flex items-center justify-center h-20 text-slate-500 text-sm">${LANG==='da'?'Ingen mÃ¸ller':'No turbines'}</div>`; return; }
  el.innerHTML = filtered.map(t => {
    const pw  = t.latest?.power_kw != null ? (t.latest.power_kw/1000).toFixed(2) + ' MW' : TXT.na;
    const wd  = t.latest?.wind_ms  != null ? t.latest.wind_ms.toFixed(1)  + ' m/s' : TXT.na;
    return `<a href="/turbine/${t.id}" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-700/50 transition-colors cursor-pointer">
      <div class="flex items-center justify-center w-6">${TURBINE_SVG_SMALL(STATUS_COL[t.status] || '#6b7280', t.id)}</div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <span class="font-semibold text-white text-sm">${t.name}</span>
          ${t.open_events > 0 ? `<span class="text-xs bg-red-900/60 text-red-300 px-1.5 py-0.5 rounded-full">${t.open_events}</span>` : ''}
        </div>
        <div class="text-xs text-slate-400">${t.make} Â· ${t.model}</div>
      </div>
      <div class="text-right text-xs text-slate-400">
        <div>${pw}</div>
        <div>${wd}</div>
      </div>
    </a>`;
  }).join('');
}

// â”€â”€ 16 Turbine Mini-Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTurbineGrid(data) {
  const mode = getSensorMode();
  document.getElementById('turbineGrid').innerHTML = data.map(t => {
    const l = t.latest || {};
    const borderCol = {operational:'border-green-800', warning:'border-amber-700', fault:'border-red-800', offline:'border-slate-700'}[t.status] || 'border-slate-700';

    // External sensors (X â€” outside the monitoring box): Power, Wind, RPM, Bearing temp
    const pw  = l.power_kw    != null ? (l.power_kw/1000).toFixed(2) : 'â€”';
    const wd  = l.wind_ms     != null ? l.wind_ms.toFixed(1) : 'â€”';
    const rp  = l.rpm         != null ? l.rpm.toFixed(1) : 'â€”';
    const btp = l.bearing_temp!= null ? l.bearing_temp.toFixed(0) : 'â€”';

    // Internal sensors (O â€” inside the monitoring box): Vibration, Acoustic, Ambient temp
    const vib = l.vib_x       != null ? l.vib_x.toFixed(3) : 'â€”';
    const acu = l.acoustic_db != null ? l.acoustic_db.toFixed(0) : 'â€”';
    const atp = l.ambient_temp!= null ? l.ambient_temp.toFixed(0) : 'â€”';

    let cells = '';
    if (mode === 'external' || mode === 'all') {
      cells += `<div><span class="text-slate-500">${TXT.power}</span><br><span class="text-sky-300 font-semibold">${pw} MW</span></div>`;
      cells += `<div><span class="text-slate-500">${TXT.wind}</span><br><span class="text-emerald-300 font-semibold">${wd} m/s</span></div>`;
      cells += `<div><span class="text-slate-500">${TXT.rpm}</span><br><span class="text-purple-300">${rp}</span></div>`;
      cells += `<div><span class="text-slate-500">${TXT.temp}</span><br><span class="text-orange-300">${btp}Â°C</span></div>`;
    }
    if (mode === 'internal' || mode === 'all') {
      cells += `<div><span class="text-slate-500">${LANG==='da'?'Vib':'Vib'}</span><br><span class="text-red-300">${vib}g</span></div>`;
      cells += `<div><span class="text-slate-500">${LANG==='da'?'Akustik':'Acoustic'}</span><br><span class="text-teal-300">${acu} dB</span></div>`;
      cells += `<div><span class="text-slate-500">${LANG==='da'?'Kabinettmp.':'Housing'}</span><br><span class="text-cyan-300">${atp}Â°C</span></div>`;
    }

    const modeBadge = mode !== 'all'
      ? `<div class="text-xs ${mode==='internal'?'text-sky-500':'text-emerald-600'} font-medium mt-0.5">
           ${mode==='internal'
             ? (LANG==='da'?'ğŸ”§ Intern sensor':'ğŸ”§ Internal sensor')
             : (LANG==='da'?'ğŸŒ¤ Ekstern sensor':'ğŸŒ¤ External sensor')}
         </div>` : '';

    return `<a href="/turbine/${t.id}" class="card border ${borderCol} p-3 flex flex-col gap-2 hover:border-sky-600 transition-colors cursor-pointer no-underline">
      <div class="flex items-center justify-between">
        <span class="font-bold text-white text-sm">${t.name}</span>
        ${TURBINE_SVG_SMALL(STATUS_COL[t.status] || '#6b7280', t.id)}
      </div>
      <div class="text-xs text-slate-500">${t.make}</div>
      ${modeBadge}
      <div class="grid grid-cols-2 gap-1 text-xs mt-1">${cells}</div>
      ${t.open_events > 0 ? `<div class="text-xs text-amber-400 font-medium">âš  ${t.open_events} ${LANG==='da'?'advarsel(er)':'alert(s)'}</div>` : ''}
    </a>`;
  }).join('');
}

// â”€â”€ Google Maps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeTurbineSvgEl(col, tid=0) {
  const v = (tid - 1 + 3) % 3;
  const el = document.createElement('div');
  el.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${TURBINE_VIEWBOXES[v]}" width="28" height="75" fill="${col}"><path d="${TURBINE_PATHS[v]}"/></svg>`;
  el.style.cursor = 'pointer';
  return el;
}

let gmapsLoaded = false;
let pendingMapData = null;

// Auth failure handler â€” called by Google Maps if key is invalid/restricted
window.gm_authFailure = function() {
  console.error('[Maps] Auth failure â€” check API key and HTTP referrer restrictions');
  const el = document.getElementById('map');
  if (el) el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:13px;flex-direction:column;gap:8px"><span style="font-size:24px">ğŸ—ºï¸</span><span>Map unavailable â€” check Google Maps API key</span></div>';
};

async function renderMap(data) {
  pendingMapData = data;
  if (!gmapsLoaded) {
    gmapsLoaded = true;
    // Use importLibrary bootstrap pattern (no callback, no v=beta)
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;a.onerror=()=>n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a);d[q]=f}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
    ({key: window.GOOGLE_MAPS_KEY, v: "weekly"});
    _initFleetMap();
  } else if (mapInstance) {
    _placeMarkers(data);
  }
}

let AdvancedMarkerElement = null;

async function _initFleetMap() {
  try {
    const { Map } = await google.maps.importLibrary('maps');
    const markerLib = await google.maps.importLibrary('marker');
    AdvancedMarkerElement = markerLib.AdvancedMarkerElement;

    const data = pendingMapData || [];
    if (!data.length) return;

    const avgLat = data.reduce((s,t) => s + t.lat, 0) / data.length;
    const avgLng = data.reduce((s,t) => s + t.lng, 0) / data.length;

    mapInstance = new Map(document.getElementById('map'), {
      center: { lat: avgLat, lng: avgLng },
      zoom: 12,
      mapId: 'DEMO_MAP_ID',
      colorScheme: 'DARK',
      mapTypeId: 'roadmap',
      zoomControl: true,
      streetViewControl: false,
      mapTypeControl: false,
      fullscreenControl: false,
    });

    _placeMarkers(data);
  } catch(err) {
    console.error('[Maps] Init failed:', err);
    const el = document.getElementById('map');
    if (el) el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:13px;flex-direction:column;gap:8px"><span style="font-size:24px">ğŸ—ºï¸</span><span>Map unavailable</span></div>';
  }
}

function _placeMarkers(data) {
  const colMap = { operational:'#22c55e', warning:'#f59e0b', fault:'#ef4444', offline:'#6b7280' };

  // Remove old markers
  Object.values(markers).forEach(m => m.map = null);
  markers = {};

  const bounds = new google.maps.LatLngBounds();

  data.forEach(t => {
    const col = colMap[t.status] || '#6b7280';
    const markerEl = makeTurbineSvgEl(col, t.id);

    // Wrap SVG + hover label in a container
    const markerWrapper = document.createElement('div');
    markerWrapper.style.cssText = 'position:relative;display:flex;flex-direction:column;align-items:center;cursor:pointer';
    markerWrapper.appendChild(markerEl);

    // Hover tooltip showing turbine name
    const tooltip = document.createElement('div');
    tooltip.textContent = t.name;
    tooltip.style.cssText = 'position:absolute;bottom:40px;left:50%;transform:translateX(-50%);background:#0f172a;color:#e2e8f0;font-size:11px;font-weight:600;padding:3px 7px;border-radius:4px;white-space:nowrap;border:1px solid #334155;opacity:0;transition:opacity 0.15s;pointer-events:none;font-family:system-ui';
    markerWrapper.appendChild(tooltip);
    markerWrapper.addEventListener('mouseenter', () => tooltip.style.opacity = '1');
    markerWrapper.addEventListener('mouseleave', () => tooltip.style.opacity = '0');

    const marker = new AdvancedMarkerElement({
      map: mapInstance,
      position: { lat: t.lat, lng: t.lng },
      content: markerWrapper,
      title: t.name,
    });

    // Click navigates directly to turbine detail page
    marker.addListener('gmp-click', () => {
      window.location.href = `/turbine/${t.id}`;
    });

    markers[t.id] = marker;
    bounds.extend({ lat: t.lat, lng: t.lng });
  });

  if (data.length > 0) mapInstance.fitBounds(bounds, { padding: 40 });
}

// â”€â”€ Fleet Power Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let powerChart;
let currentPowerRange = '48h';

async function loadFleetPower(range) {
  range = range || currentPowerRange;
  currentPowerRange = range;

  // Update toggle buttons
  document.querySelectorAll('.power-range').forEach(b => {
    b.className = 'power-range text-xs px-2 py-0.5 rounded text-slate-400 hover:text-white';
  });
  const activeBtn = document.getElementById('btn-' + range);
  if (activeBtn) activeBtn.className = 'power-range text-xs px-2 py-0.5 rounded bg-sky-700 text-white';

  // Update chart title
  const titleEl = document.getElementById('fleetPowerTitle');
  if (titleEl) {
    titleEl.textContent = range === '7d'
      ? (LANG==='da' ? 'Samlet flÃ¥deproduktion Â· Seneste 7 dage' : 'Total Fleet Output Â· Last 7 days')
      : (LANG==='da' ? 'Samlet flÃ¥deproduktion Â· Seneste 48 timer' : 'Total Fleet Output Â· Last 48 hours');
  }

  const r = await fetch(`/api/fleet/power?range=${range}`);
  const d = await r.json();
  if (!d.length) return;

  const timeUnit = range === '7d' ? 'day' : 'hour';
  const displayFormats = range === '7d'
    ? { day: 'EEE d MMM', hour: 'HH:mm' }
    : { hour: 'HH:mm', day: 'd MMM' };

  const ctx = document.getElementById('fleetPowerChart').getContext('2d');
  if (powerChart) powerChart.destroy();

  powerChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: d.map(x => new Date(x.t)),
      datasets: [
        {
          label: LANG==='da' ? 'Total effekt (MW)' : 'Total Output (MW)',
          data: d.map(x => (x.total_kw/1000).toFixed(2)),
          backgroundColor: 'rgba(14,165,233,0.35)',
          borderColor: 'rgba(14,165,233,0.8)',
          borderWidth: 1,
          borderRadius: 2,
          yAxisID: 'y',
        },
        {
          label: LANG==='da' ? 'Gns. vind (m/s)' : 'Avg Wind (m/s)',
          data: d.map(x => x.avg_wind.toFixed(2)),
          type: 'line',
          borderColor: 'rgba(52,211,153,0.8)',
          backgroundColor: 'transparent',
          pointRadius: 0,
          borderWidth: 1.5,
          tension: 0.4,
          yAxisID: 'y2',
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color:'#94a3b8', font:{size:11}, padding:18,
            usePointStyle:true, pointStyle:'circle', boxWidth:6, boxHeight:6,
            generateLabels(chart) {
              return Chart.defaults.plugins.legend.labels.generateLabels(chart).map(item => {
                const ds = chart.data.datasets[item.datasetIndex];
                const col = (typeof ds.borderColor==='string' ? ds.borderColor : null)
                         || (typeof ds.backgroundColor==='string' ? ds.backgroundColor : null)
                         || item.fillStyle;
                item.fillStyle = col; item.strokeStyle = col; item.lineWidth = 0; item.pointStyle = 'circle';
                return item;
              });
            }
          }
        },
        tooltip: {
          backgroundColor:'rgba(15,23,42,0.95)', borderColor:'#334155', borderWidth:1,
          titleColor:'#e2e8f0', titleFont:{weight:'bold',size:12},
          bodyColor:'#94a3b8', bodyFont:{size:12},
          padding:12, boxWidth:8, boxHeight:8,
          usePointStyle:true, pointStyle:'circle', bodySpacing:6,
          callbacks: {
            labelPointStyle: () => ({ pointStyle:'circle', rotation:0 }),
            labelColor(ctx) {
              const ds = ctx.chart.data.datasets[ctx.datasetIndex];
              const col = (typeof ds.borderColor==='string' ? ds.borderColor : null)
                       || (typeof ds.backgroundColor==='string' ? ds.backgroundColor : null)
                       || '#94a3b8';
              return { borderColor:col, backgroundColor:col, borderWidth:0, borderRadius:4 };
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: timeUnit, displayFormats },
          grid: { color:'rgba(51,65,85,0.5)' },
          ticks: { color:'#64748b', maxTicksLimit: range==='7d' ? 7 : 12, font:{size:10} }
        },
        y:  { grid:{color:'rgba(51,65,85,0.5)'}, ticks:{color:'#64748b', font:{size:10}}, position:'left'  },
        y2: { grid:{display:false}, ticks:{color:'#34d399', font:{size:10}}, position:'right' },
      }
    }
  });
  document.getElementById('fleetPowerUpdated').textContent = new Date().toLocaleTimeString();
}

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEvents() {
  const r = await fetch('/api/events?limit=15');
  const events = await r.json();
  const el = document.getElementById('eventsList');
  if (!events.length) { el.innerHTML = `<div class="px-4 py-4 text-slate-500 text-sm">${LANG==='da'?'Ingen hÃ¦ndelser':'No events'}</div>`; return; }
  const sevCol = { critical:'text-red-400', fault:'text-red-300', warning:'text-amber-300', info:'text-sky-300' };
  const sevIcon = { critical:'ğŸ”´', fault:'ğŸ”´', warning:'ğŸŸ¡', info:'ğŸ”µ' };
  el.innerHTML = events.map(e => `
    <div class="px-4 py-2.5 border-b border-slate-800 hover:bg-slate-700/30 transition-colors">
      <div class="flex items-start gap-2">
        <span class="text-sm mt-0.5">${e.category==='AI Analysis' ? 'ğŸ¤–' : (sevIcon[e.severity]||'âšª')}</span>
        <div class="flex-1 min-w-0">
          <div class="text-xs font-semibold ${sevCol[e.severity]||'text-slate-300'}">${e.friendly_code || e.code} Â· ${e.turbine_id ? 'T-'+e.turbine_id : ''}</div>
          <div class="text-xs text-slate-300 mt-0.5 line-clamp-2">${e.message}</div>
          <div class="text-xs text-slate-600 mt-1">${new Date(e.ts).toLocaleString()}</div>
        </div>
      </div>
    </div>
  `).join('');
}

// â”€â”€ Sensor mode label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSensorModeLabel(mode) {
  const el = document.getElementById('sensorModeLabel');
  if (!el) return;
  const cfg = {
    internal: { text: LANG==='da' ? 'ğŸ”§ Interne sensorer' : 'ğŸ”§ Internal sensors', cls: 'bg-sky-900/50 text-sky-400 border border-sky-700/40' },
    external: { text: LANG==='da' ? 'ğŸŒ¤ Eksterne sensorer' : 'ğŸŒ¤ External sensors', cls: 'bg-emerald-900/50 text-emerald-400 border border-emerald-700/40' },
    all:      { text: LANG==='da' ? 'âš¡ Alle sensorer'     : 'âš¡ All sensors',      cls: 'bg-slate-700/50 text-slate-400 border border-slate-600/40' },
  };
  const c = cfg[mode] || cfg.all;
  el.textContent = c.text;
  el.className = `text-xs px-2 py-0.5 rounded-full font-medium ${c.cls}`;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateSensorModeLabel(getSensorMode());
loadFleet();
loadEvents();
loadFleetPower();

// Re-render turbine grid when sensor mode changes (nav toggle)
window.addEventListener('sensorModeChange', (e) => {
  updateSensorModeLabel(e.detail.mode);
  if (fleetData.length) renderTurbineGrid(fleetData);
});

// Auto-refresh every 60 seconds
setInterval(() => { loadFleet(); loadEvents(); loadFleetPower(currentPowerRange); }, 60000);
</script>
{% endblock %}
