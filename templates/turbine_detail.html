{% extends "base.html" %}
{% block title %}Wind Monitor Â· {{ turbine.name }}{% endblock %}

{% block head_extra %}
<script>
  window.GOOGLE_MAPS_KEY = "{{ google_maps_key }}";
</script>
{% endblock %}

{% block content %}
<!-- â”€â”€ Back + Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="flex flex-wrap items-center gap-3 mb-4">
  <a href="{{ url_for('dashboard') }}" class="flex items-center gap-1 text-slate-400 hover:text-white text-sm transition-colors">
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    {% if lang=='da' %}Tilbage{% else %}Back{% endif %}
  </a>
  <div class="flex-1">
    <div class="flex flex-wrap items-center gap-3">
      <h1 class="text-xl font-bold text-white" id="turbineName">{{ turbine.name }}</h1>
      <span id="statusBadgeEl" class="px-2.5 py-0.5 rounded-full text-xs font-semibold badge-{{ turbine.status }}">{{ turbine.status }}</span>
    </div>
    <div class="text-sm text-slate-400 mt-0.5">{{ turbine.make }} {{ turbine.model }} Â· {{ turbine.serial_number }}</div>
  </div>
  <!-- AI Analyze button (stub) -->
  <button onclick="runAiAnalysis()" class="flex items-center gap-2 px-4 py-2 bg-violet-700 hover:bg-violet-600 text-white text-sm rounded-lg transition-colors">
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17H4a2 2 0 01-2-2V5a2 2 0 012-2h16a2 2 0 012 2v10a2 2 0 01-2 2h-1"/></svg>
    {% if lang=='da' %}AI Analyse{% else %}AI Analysis{% endif %}
  </button>
</div>

<!-- â”€â”€ Info Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3 mb-4 text-sm">
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}MÃ¦rkeeffekt{% else %}Rated Power{% endif %}</div>
    <div class="font-semibold text-sky-300">{{ turbine.rated_power_kw|int }} kW</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}NavhÃ¸jde{% else %}Hub Height{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.hub_height_m|int }} m</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}Rotordiameter{% else %}Rotor Diameter{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.rotor_diameter_m|int }} m</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}Byggested{% else %}Build Date{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.build_date }}</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}Seneste service{% else %}Last Service{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.last_service_date }}</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">GPS</div>
    <div class="font-semibold text-white text-xs">{{ "%.4f"|format(turbine.latitude) }}, {{ "%.4f"|format(turbine.longitude) }}</div>
  </div>
</div>

<!-- â”€â”€ Live Gauges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3 mb-4">
  <!-- Power gauge -->
  <div class="sm:col-span-2 card px-4 pt-3 pb-4 flex flex-col items-center gap-1">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Effekt{% else %}Power Output{% endif %}</div>
    <canvas id="gaugePower" width="140" height="80"></canvas>
    <div id="valPower" class="text-xl font-bold text-sky-400 -mt-1">â€”</div>
    <div class="text-xs text-slate-500">kW / {{ turbine.rated_power_kw|int }} kW</div>
  </div>
  <!-- Wind speed -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Vind{% else %}Wind{% endif %}</div>
    <canvas id="gaugeWind" width="90" height="52"></canvas>
    <div id="valWind" class="text-lg font-bold text-emerald-400 -mt-1">â€”</div>
    <div class="text-xs text-slate-500">m/s</div>
  </div>
  <!-- RPM -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1">
    <div class="text-xs text-slate-400 uppercase tracking-wide">RPM</div>
    <canvas id="gaugeRpm" width="90" height="52"></canvas>
    <div id="valRpm" class="text-lg font-bold text-purple-400 -mt-1">â€”</div>
    <div class="text-xs text-slate-500">r/min</div>
  </div>
  <!-- Bearing Temp -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Lejetemperatur{% else %}Bearing Temp{% endif %}</div>
    <canvas id="gaugeBearingTemp" width="90" height="52"></canvas>
    <div id="valBearingTemp" class="text-lg font-bold text-orange-400 -mt-1">â€”</div>
    <div class="text-xs text-slate-500">Â°C</div>
  </div>
  <!-- Gearbox Temp -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Gearkasse{% else %}Gearbox{% endif %}</div>
    <canvas id="gaugeGearboxTemp" width="90" height="52"></canvas>
    <div id="valGearboxTemp" class="text-lg font-bold text-orange-300 -mt-1">â€”</div>
    <div class="text-xs text-slate-500">Â°C</div>
  </div>
  <!-- Vibration X -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1">
    <div class="text-xs text-slate-400 uppercase tracking-wide">Vibration X</div>
    <canvas id="gaugeVibX" width="90" height="52"></canvas>
    <div id="valVibX" class="text-lg font-bold text-red-400 -mt-1">â€”</div>
    <div class="text-xs text-slate-500">g</div>
  </div>
  <!-- Acoustic -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Lydniveau{% else %}Acoustic{% endif %}</div>
    <canvas id="gaugeAcoustic" width="90" height="52"></canvas>
    <div id="valAcoustic" class="text-lg font-bold text-teal-400 -mt-1">â€”</div>
    <div class="text-xs text-slate-500">dB</div>
  </div>
</div>

<!-- â”€â”€ Time-Series Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
  <!-- Power + Wind -->
  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">{% if lang=='da' %}Effekt & Vindhastighed{% else %}Power Output & Wind Speed{% endif %}</h2>
      <div class="flex gap-1 text-xs">
        <button onclick="setRange('24h')" id="range-24h" class="range-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
        <button onclick="setRange('7d')"  id="range-7d"  class="range-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
        <button onclick="setRange('21d')" id="range-21d" class="range-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
      </div>
    </div>
    <div style="height:200px;"><canvas id="chartPowerWind"></canvas></div>
  </div>

  <!-- Temperature -->
  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">{% if lang=='da' %}Temperaturer{% else %}Temperatures{% endif %}</h2>
      <div class="flex gap-1 text-xs">
        <button onclick="setRange2('24h')" id="range2-24h" class="range2-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
        <button onclick="setRange2('7d')"  id="range2-7d"  class="range2-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
        <button onclick="setRange2('21d')" id="range2-21d" class="range2-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
      </div>
    </div>
    <div style="height:200px;"><canvas id="chartTemps"></canvas></div>
  </div>

  <!-- Vibration -->
  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">{% if lang=='da' %}Vibration (gearkasse){% else %}Vibration (Gearbox){% endif %}</h2>
      <div class="flex gap-1 text-xs">
        <button onclick="setRange('24h')" id="range3-24h" class="range3-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
        <button onclick="setRange('7d')"  id="range3-7d"  class="range3-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
        <button onclick="setRange('21d')" id="range3-21d" class="range3-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
      </div>
    </div>
    <div style="height:180px;"><canvas id="chartVibration"></canvas></div>
  </div>

  <!-- RPM + Pitch -->
  <div class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">RPM & {% if lang=='da' %}Pitch{% else %}Pitch Angle{% endif %}</h2>
      <div class="flex gap-1 text-xs">
        <button onclick="setRange('24h')" id="range4-24h" class="range4-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
        <button onclick="setRange('7d')"  id="range4-7d"  class="range4-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
        <button onclick="setRange('21d')" id="range4-21d" class="range4-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
      </div>
    </div>
    <div style="height:180px;"><canvas id="chartRpmPitch"></canvas></div>
  </div>
</div>

<!-- â”€â”€ Map + Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
  <!-- Mini map -->
  <div class="card overflow-hidden" style="height:280px;">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 text-sm font-semibold text-white">
      {% if lang=='da' %}MÃ¸llens placering{% else %}Turbine Location{% endif %}
    </div>
    <div id="turbineMap" style="height:240px;"></div>
  </div>

  <!-- Event log -->
  <div class="card overflow-hidden" style="height:280px;">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 text-sm font-semibold text-white flex items-center justify-between">
      {% if lang=='da' %}HÃ¦ndelseslog{% else %}Event Log{% endif %}
      <span id="eventCount" class="text-xs text-slate-400"></span>
    </div>
    <div id="eventLog" class="overflow-y-auto" style="max-height:236px;"></div>
  </div>
</div>

<!-- â”€â”€ AI Analysis Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="aiModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
  <div class="card p-6 max-w-xl w-full">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-bold text-white text-lg">ðŸ¤– {% if lang=='da' %}AI Diagnose{% else %}AI Diagnostic{% endif %}</h2>
      <button onclick="document.getElementById('aiModal').classList.add('hidden')" class="text-slate-400 hover:text-white text-xl">âœ•</button>
    </div>

    <!-- Loading state -->
    <div id="aiLoading" class="text-sm text-slate-400 py-6 text-center">
      <div class="animate-pulse">{% if lang=='da' %}Analyserer sensordata...{% else %}Analyzing sensor data...{% endif %}</div>
    </div>

    <!-- Summary card (shown after load) -->
    <div id="aiSummary" class="hidden">
      <!-- Verdict badge -->
      <div class="flex items-center gap-3 mb-4">
        <span id="aiVerdict" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"></span>
        <span id="aiPF" class="text-xs text-slate-400"></span>
      </div>
      <!-- Summary sentence -->
      <p id="aiSummaryText" class="text-sm text-slate-200 leading-relaxed mb-3"></p>
      <!-- Next step highlight -->
      <div class="bg-blue-950/60 border border-blue-700/40 rounded-lg px-4 py-3 mb-4">
        <p class="text-xs text-blue-400 font-semibold uppercase tracking-wide mb-1">{% if lang=='da' %}Anbefalet nÃ¦ste skridt{% else %}Recommended Next Step{% endif %}</p>
        <p id="aiNextStep" class="text-sm text-white"></p>
      </div>
      <!-- Expand toggle -->
      <button id="aiExpandBtn" onclick="toggleFullAnalysis()"
        class="text-xs text-slate-400 hover:text-white underline underline-offset-2">
        {% if lang=='da' %}Vis fuld analyse â–¾{% else %}Show full analysis â–¾{% endif %}
      </button>
      <!-- Full analysis (collapsed by default) -->
      <div id="aiFullAnalysis" class="hidden mt-4 space-y-3 max-h-80 overflow-y-auto pr-1"></div>
    </div>

    <!-- Error state -->
    <div id="aiError" class="hidden text-sm text-red-400 py-4"></div>

    <p class="text-xs text-slate-500 mt-4">
      {% if lang=='da' %}Drevet af Claude Â· Resultater logges i hÃ¦ndelseslog{% else %}Powered by Claude Â· Results logged to event log{% endif %}
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const TURBINE_ID = {{ turbine.id }};
const RATED_KW   = {{ turbine.rated_power_kw }};

// â”€â”€ Gauge Drawing (Canvas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGauge(canvasId, value, max, color, thresholds) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const cx = w / 2, cy = h * 0.78;
  const r  = Math.min(w, h) * 0.65;
  const startAngle = Math.PI, endAngle = 2 * Math.PI;
  const pct = Math.min(1, Math.max(0, value / max));

  // Background arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, endAngle);
  ctx.lineWidth = 10;
  ctx.strokeStyle = '#334155';
  ctx.lineCap = 'round';
  ctx.stroke();

  // Determine color from thresholds
  let arcColor = color;
  if (thresholds) {
    if (value >= thresholds.critical) arcColor = '#ef4444';
    else if (value >= thresholds.warning) arcColor = '#f59e0b';
  }

  // Value arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, startAngle + pct * Math.PI);
  ctx.lineWidth = 10;
  ctx.strokeStyle = arcColor;
  ctx.lineCap = 'round';
  ctx.stroke();

  // Needle
  const angle = Math.PI + pct * Math.PI;
  const nx = cx + (r * 0.75) * Math.cos(angle);
  const ny = cy + (r * 0.75) * Math.sin(angle);
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(nx, ny);
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#e2e8f0';
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(cx, cy, 4, 0, 2 * Math.PI);
  ctx.fillStyle = '#e2e8f0';
  ctx.fill();
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Build chart options with correct x-axis time unit per range
function chartOpts(range, extraScales) {
  const unit = range === '24h' ? 'hour' : (range === '7d' ? 'day' : 'day');
  const maxTicks = range === '24h' ? 8 : (range === '7d' ? 7 : 7);
  const fmt = range === '24h'
    ? { hour: 'HH:mm', minute: 'HH:mm' }
    : { day: 'd MMM', hour: 'HH:mm' };
  const base = {
    responsive: true, maintainAspectRatio: false,
    animation: { duration: 300 },
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 12 }, position: 'bottom' } },
    scales: {
      x: { type: 'time', time: { unit, displayFormats: fmt }, grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#64748b', maxTicksLimit: maxTicks, font: { size: 10 } } },
      y: { grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#64748b', font: { size: 10 } } },
      ...(extraScales || {})
    }
  };
  return base;
}

let chartPW, chartT, chartV, chartRP;
let currentRange = '24h';

async function fetchMetric(metric, range) {
  const r = await fetch(`/api/turbine/${TURBINE_ID}/chart?metric=${metric}&range=${range}`);
  return (await r.json()).data;
}

async function loadPowerWindChart(range) {
  const [pw, wd] = await Promise.all([fetchMetric('power_output_kw', range), fetchMetric('wind_speed_ms', range)]);
  const ctx = document.getElementById('chartPowerWind').getContext('2d');
  if (chartPW) chartPW.destroy();
  chartPW = new Chart(ctx, {
    data: {
      datasets: [
        { type:'bar',  label: LANG==='da'?'Effekt (kW)':'Power (kW)', data: pw.map(d=>({x:new Date(d.t),y:d.v})), backgroundColor:'rgba(14,165,233,0.35)', borderColor:'rgba(14,165,233,0.8)', borderWidth:1, borderRadius:1, yAxisID:'y' },
        { type:'line', label: LANG==='da'?'Vind (m/s)':'Wind (m/s)', data: wd.map(d=>({x:new Date(d.t),y:d.v})), borderColor:'rgba(52,211,153,0.8)', backgroundColor:'transparent', pointRadius:0, borderWidth:1.5, tension:0.4, yAxisID:'y2' },
      ]
    },
    options: chartOpts(range, { y:{ grid:{color:'rgba(51,65,85,0.5)'}, ticks:{color:'#64748b',font:{size:10}}, position:'left' }, y2:{ grid:{display:false}, ticks:{color:'#34d399',font:{size:10}}, position:'right' } })
  });
}

async function loadTempChart(range) {
  const [bt, gt, gen, ot] = await Promise.all([
    fetchMetric('bearing_temp_c', range),
    fetchMetric('gearbox_temp_c', range),
    fetchMetric('generator_temp_c', range),
    fetchMetric('oil_temp_c', range),
  ]);
  const ctx = document.getElementById('chartTemps').getContext('2d');
  if (chartT) chartT.destroy();
  chartT = new Chart(ctx, {
    type:'line',
    data: {
      datasets: [
        { label: LANG==='da'?'Leje':'Bearing',     data: bt.map(d=>({x:new Date(d.t),y:d.v})),  borderColor:'#f97316', pointRadius:0, borderWidth:1.5, tension:0.4 },
        { label: LANG==='da'?'Gearkasse':'Gearbox', data: gt.map(d=>({x:new Date(d.t),y:d.v})),  borderColor:'#fb923c', pointRadius:0, borderWidth:1.5, tension:0.4 },
        { label: 'Generator',                        data: gen.map(d=>({x:new Date(d.t),y:d.v})), borderColor:'#fbbf24', pointRadius:0, borderWidth:1.5, tension:0.4 },
        { label: LANG==='da'?'Olie':'Oil',           data: ot.map(d=>({x:new Date(d.t),y:d.v})),  borderColor:'#a78bfa', pointRadius:0, borderWidth:1.5, tension:0.4 },
      ]
    },
    options: chartOpts(range)
  });
}

async function loadVibrationChart(range) {
  range = range || currentRange;
  const [vx, vy, vz] = await Promise.all([
    fetchMetric('vibration_gearbox_x', range),
    fetchMetric('vibration_gearbox_y', range),
    fetchMetric('vibration_gearbox_z', range),
  ]);
  const ctx = document.getElementById('chartVibration').getContext('2d');
  if (chartV) chartV.destroy();
  const opts = chartOpts(range);
  opts.plugins.annotation = { annotations: { threshold: { type:'line', yMin:0.5, yMax:0.5, borderColor:'rgba(239,68,68,0.5)', borderWidth:1, borderDash:[6,4], label:{content:LANG==='da'?'GrÃ¦nse':'Limit',enabled:true,color:'#ef4444',font:{size:9}} } } };
  chartV = new Chart(ctx, {
    type:'line',
    data: {
      datasets: [
        { label:'X', data: vx.map(d=>({x:new Date(d.t),y:d.v})), borderColor:'#ef4444', pointRadius:0, borderWidth:1.5, tension:0.4 },
        { label:'Y', data: vy.map(d=>({x:new Date(d.t),y:d.v})), borderColor:'#a855f7', pointRadius:0, borderWidth:1.5, tension:0.4 },
        { label:'Z', data: vz.map(d=>({x:new Date(d.t),y:d.v})), borderColor:'#3b82f6', pointRadius:0, borderWidth:1.5, tension:0.4 },
      ]
    },
    options: opts
  });
}

async function loadRpmPitchChart(range) {
  range = range || currentRange;
  const [rpm, pitch] = await Promise.all([
    fetchMetric('rotor_rpm', range),
    fetchMetric('pitch_angle_deg', range),
  ]);
  const ctx = document.getElementById('chartRpmPitch').getContext('2d');
  if (chartRP) chartRP.destroy();
  chartRP = new Chart(ctx, {
    data: {
      datasets: [
        { type:'line', label:'RPM',                           data: rpm.map(d=>({x:new Date(d.t),y:d.v})),   borderColor:'#a855f7', backgroundColor:'transparent', pointRadius:0, borderWidth:1.5, tension:0.4, yAxisID:'y' },
        { type:'line', label: LANG==='da'?'Pitch (Â°)':'Pitch (Â°)', data: pitch.map(d=>({x:new Date(d.t),y:d.v})), borderColor:'#06b6d4', backgroundColor:'transparent', pointRadius:0, borderWidth:1.5, tension:0.4, yAxisID:'y2' },
      ]
    },
    options: chartOpts(range, { y:{ grid:{color:'rgba(51,65,85,0.5)'}, ticks:{color:'#64748b',font:{size:10}}, position:'left' }, y2:{ grid:{display:false}, ticks:{color:'#06b6d4',font:{size:10}}, position:'right' } })
  });
}

// Single unified range setter â€” updates all 4 charts and all 4 button groups
function setRange(r) {
  currentRange = r;
  [['range-btn','range'], ['range2-btn','range2'], ['range3-btn','range3'], ['range4-btn','range4']].forEach(([cls, prefix]) => {
    document.querySelectorAll('.'+cls).forEach(b => b.className = cls+' px-2 py-0.5 rounded text-slate-400 hover:text-white');
    const btn = document.getElementById(prefix+'-'+r);
    if (btn) btn.className = cls+' px-2 py-0.5 rounded bg-sky-700 text-white';
  });
  loadPowerWindChart(r);
  loadTempChart(r);
  loadVibrationChart(r);
  loadRpmPitchChart(r);
}

// â”€â”€ Live Data & Gauges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLiveData() {
  const r = await fetch(`/api/turbine/${TURBINE_ID}`);
  const d = await r.json();
  if (!d.latest) return;
  const lt = d.latest;

  document.getElementById('valPower').textContent     = lt.power_kw != null ? Math.round(lt.power_kw) : 'â€”';
  document.getElementById('valWind').textContent      = lt.wind_ms  != null ? lt.wind_ms.toFixed(1) : 'â€”';
  document.getElementById('valRpm').textContent       = lt.rpm != null ? lt.rpm.toFixed(1) : 'â€”';
  document.getElementById('valBearingTemp').textContent  = lt.bearing_temp != null ? lt.bearing_temp.toFixed(0) : 'â€”';
  document.getElementById('valGearboxTemp').textContent  = lt.gearbox_temp != null ? lt.gearbox_temp.toFixed(0) : 'â€”';
  document.getElementById('valVibX').textContent      = lt.vib_x != null ? lt.vib_x.toFixed(3) : 'â€”';
  document.getElementById('valAcoustic').textContent  = lt.acoustic_db != null ? lt.acoustic_db.toFixed(0) : 'â€”';

  drawGauge('gaugePower',       lt.power_kw || 0, RATED_KW, '#0ea5e9',  null);
  drawGauge('gaugeWind',        lt.wind_ms || 0,  25,       '#34d399',  null);
  drawGauge('gaugeRpm',         lt.rpm || 0,      20,       '#a855f7',  null);
  drawGauge('gaugeBearingTemp', lt.bearing_temp||0, 100,    '#f97316',  {warning:70,  critical:85});
  drawGauge('gaugeGearboxTemp', lt.gearbox_temp||0, 100,    '#fb923c',  {warning:75,  critical:90});
  drawGauge('gaugeVibX',        lt.vib_x||0,      1.0,      '#ef4444',  {warning:0.3, critical:0.5});
  drawGauge('gaugeAcoustic',    lt.acoustic_db||0, 100,     '#2dd4bf',  null);

  // Render events
  renderEvents(d.events);
  document.getElementById('eventCount').textContent = `${d.events.filter(e=>!e.resolved).length} ${LANG==='da'?'Ã¥bne':'open'}`;
}

function renderEvents(events) {
  const el = document.getElementById('eventLog');
  if (!events.length) { el.innerHTML = `<div class="px-4 py-4 text-slate-500 text-sm">${LANG==='da'?'Ingen hÃ¦ndelser':'No events'}</div>`; return; }
  const sevCol  = { critical:'text-red-400', fault:'text-red-300', warning:'text-amber-300', info:'text-sky-300' };
  const sevIcon = { critical:'ðŸ”´', fault:'ðŸ”´', warning:'ðŸŸ¡', info:'ðŸ”µ' };
  const isAI = e => e.category === 'AI Analysis';
  el.innerHTML = events.map(e => {
    const statusBadge = isAI(e)
      ? `<span class="text-xs px-1.5 py-0.5 rounded bg-violet-900/40 text-violet-400">ðŸ¤– ${LANG==='da'?'AI-analyse':'AI Analysis'}</span>`
      : e.resolved
        ? `<span class="text-xs px-1.5 py-0.5 rounded bg-green-900/40 text-green-400">${LANG==='da'?'LÃ¸st':'Resolved'}</span>`
        : `<span class="text-xs px-1.5 py-0.5 rounded bg-amber-900/40 text-amber-400">${LANG==='da'?'Ã…ben':'Open'}</span>`;
    return `<div class="px-4 py-3 border-b border-slate-800 hover:bg-slate-700/30 transition-colors">
      <div class="flex items-start gap-2">
        <span class="text-sm mt-0.5">${isAI(e) ? 'ðŸ¤–' : (sevIcon[e.severity]||'âšª')}</span>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-xs font-semibold ${sevCol[e.severity]||'text-slate-300'}">${e.friendly_code || e.code}</span>
            ${statusBadge}
          </div>
          <div class="text-xs text-slate-300 mt-1">${e.message}</div>
          ${e.ai_analysis ? `<details class="mt-1.5"><summary class="text-xs text-violet-400 cursor-pointer">ðŸ¤– ${LANG==='da'?'Vis fuld analyse':'View full analysis'}</summary><div class="text-xs text-slate-400 mt-1 p-2 bg-slate-900/50 rounded leading-relaxed">${e.ai_analysis}</div></details>` : ''}
          <div class="text-xs text-slate-600 mt-1">${new Date(e.ts).toLocaleString()}</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ Mini Map (Google Maps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TURBINE_SVG_PATH_DETAIL = "M36,58.09a7.11,7.11,0,0,1,.72.41l.12.07a6,6,0,0,1,1.43,1.36,5.84,5.84,0,0,1,.89,1.76v0a5.89,5.89,0,0,1,.23,2,7.59,7.59,0,0,1-.37,2l0,0a8,8,0,0,1-.41,1,9.31,9.31,0,0,1-.52.9A9.14,9.14,0,0,1,35,70.32,25.91,25.91,0,0,1,31.55,72c-9.5,3.9-18.87,8.6-28.37,12.4a3.14,3.14,0,0,1-1,.19h0a2.28,2.28,0,0,1-1.25-.32l-.37-.29a2,2,0,0,1-.34-.47l-.1-.24L0,83a1.78,1.78,0,0,1,0-.39v0a2.28,2.28,0,0,1,.47-1.31h0a4.09,4.09,0,0,1,.68-.72C9.51,73.62,18.3,67,26.81,60.23c.6-.48,1.22-.94,1.83-1.34a11.17,11.17,0,0,1,1.93-1l.13,0a6.55,6.55,0,0,1,2.11-.43,6.76,6.76,0,0,1,2.21.32l.1,0a7.33,7.33,0,0,1,.9.35ZM21.64,114.44H38.71l6.4-43.87a1.63,1.63,0,0,1,1.62-1.49h6a1.63,1.63,0,0,1,1.6,1.36l7.4,44H78.88a.89.89,0,0,1,.88.88V122a.89.89,0,0,1-.88.88H21.64a.88.88,0,0,1-.88-.88v-6.68a.88.88,0,0,1,.88-.88Zm32-66.07a9,9,0,0,1,2.87,1.91,8.73,8.73,0,0,1,2.57,6.1v.15a8.77,8.77,0,0,1-2.59,6.24,8.69,8.69,0,0,1-2.87,1.91A8.8,8.8,0,0,1,42.09,59.9a8.84,8.84,0,0,1,0-6.75A8.8,8.8,0,0,1,44,50.28h0a9.15,9.15,0,0,1,2.87-1.9,8.81,8.81,0,0,1,6.74,0Zm0-4.58a5.59,5.59,0,0,1-.8.45,5.82,5.82,0,0,1-1.94.54A5.54,5.54,0,0,1,49,44.63l-.09,0a6.23,6.23,0,0,1-1.8-.83,6.67,6.67,0,0,1-1.39-1.23l-.11-.12a7.71,7.71,0,0,1-.59-.81c-.17-.28-.34-.58-.49-.89l0,0c-1.2-2.54-.8-5.17-.4-7.85,1.8-10,2.25-20.76,4.06-30.76a3.45,3.45,0,0,1,.32-.88l0-.07a2.42,2.42,0,0,1,.85-.86l.06,0a1.69,1.69,0,0,1,.5-.18,1.75,1.75,0,0,1,.42,0A1.89,1.89,0,0,1,51,.13l.32.16a2.31,2.31,0,0,1,.88,1l.06.12a3.94,3.94,0,0,1,.28,1.09c1.76,10.18,2.74,21.75,4,32.13a2.2,2.2,0,0,1,0,.36h0c.08.7.15,1.39.17,2.07a11,11,0,0,1-.13,2.25v.07a6.83,6.83,0,0,1-.72,2,6.51,6.51,0,0,1-1.52,1.83,7.06,7.06,0,0,1-.78.57Zm7,21a7,7,0,0,1,0-.92,5.83,5.83,0,0,1,.5-2,5.43,5.43,0,0,1,1-1.54l.09-.09a6.08,6.08,0,0,1,1.61-1.14,7.46,7.46,0,0,1,1.78-.6l.14,0a7.57,7.57,0,0,1,1-.11,8.14,8.14,0,0,1,1,0h.07a9.28,9.28,0,0,1,3.92,1.33A27.18,27.18,0,0,1,74.93,62c8.12,6.31,16.34,12.51,24.52,18.76l.14.12a3.78,3.78,0,0,1,.61.78,2.44,2.44,0,0,1,.32,1.15l0,.26,0,.17a1.89,1.89,0,0,1-.24.6,2.05,2.05,0,0,1-.39.44l-.14.1a1.75,1.75,0,0,1-.27.16,2.51,2.51,0,0,1-1.36.2,4,4,0,0,1-1-.26L67,71.84c-.7-.29-1.4-.61-2.07-1A11.37,11.37,0,0,1,63,69.63l-.05,0a6.48,6.48,0,0,1-2.22-3.83,6.12,6.12,0,0,1-.11-1Z";

function initTurbineMap(lat, lng) {
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_KEY}&libraries=marker&v=beta&callback=_initDetailMap`;
  script.async = true;
  window._detailMapLat = lat;
  window._detailMapLng = lng;
  document.head.appendChild(script);
}

window._initDetailMap = async function() {
  const { Map, ColorScheme } = await google.maps.importLibrary('maps');
  const lat = window._detailMapLat;
  const lng = window._detailMapLng;

  const m = new Map(document.getElementById('turbineMap'), {
    center: { lat, lng },
    zoom: 13,
    mapId: 'DEMO_MAP_ID',        // required for AdvancedMarkerElement
    colorScheme: ColorScheme.DARK,
    mapTypeId: 'roadmap',
    disableDefaultUI: false,
    zoomControl: true,
    streetViewControl: false,
    mapTypeControl: false,
    fullscreenControl: false,
  });

  const markerEl = document.createElement('div');
  markerEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100.52 122.88" width="40" height="49" fill="#38bdf8"><path d="${TURBINE_SVG_PATH_DETAIL}"/></svg>`;

  new google.maps.marker.AdvancedMarkerElement({
    map: m,
    position: { lat, lng },
    content: markerEl,
  });
};

// â”€â”€ AI Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VERDICT_STYLE = {
  'OK':               'bg-green-900/60 text-green-300 border border-green-700/50',
  'MONITOR':          'bg-yellow-900/60 text-yellow-300 border border-yellow-700/50',
  'ACTION REQUIRED':  'bg-orange-900/60 text-orange-300 border border-orange-700/50',
  'CRITICAL':         'bg-red-900/60 text-red-300 border border-red-700/50',
};

function toggleFullAnalysis() {
  const el = document.getElementById('aiFullAnalysis');
  const btn = document.getElementById('aiExpandBtn');
  const hidden = el.classList.toggle('hidden');
  btn.textContent = hidden
    ? (LANG==='da' ? 'Vis fuld analyse â–¾' : 'Show full analysis â–¾')
    : (LANG==='da' ? 'Skjul fuld analyse â–´' : 'Hide full analysis â–´');
}

async function runAiAnalysis() {
  // Reset modal state
  document.getElementById('aiModal').classList.remove('hidden');
  document.getElementById('aiLoading').classList.remove('hidden');
  document.getElementById('aiSummary').classList.add('hidden');
  document.getElementById('aiError').classList.add('hidden');
  document.getElementById('aiFullAnalysis').classList.add('hidden');

  try {
    const r = await fetch(`/api/ai/analyze/${TURBINE_ID}`, { method:'POST' });
    const d = await r.json();

    document.getElementById('aiLoading').classList.add('hidden');

    if (d.status === 'stub') {
      document.getElementById('aiError').textContent = LANG==='da'
        ? 'AI-integration ikke konfigureret. TilfÃ¸j ANTHROPIC_API_KEY i miljÃ¸variablerne.'
        : 'AI not configured. Add ANTHROPIC_API_KEY environment variable.';
      document.getElementById('aiError').classList.remove('hidden');
      return;
    }

    if (d.status === 'error') {
      document.getElementById('aiError').textContent = `Error: ${d.message}`;
      document.getElementById('aiError').classList.remove('hidden');
      return;
    }

    const s = d.structured;
    if (!s) {
      // Fallback: no structured parse, show raw
      const fb = document.getElementById('aiFullAnalysis');
      fb.innerHTML = `<pre class="text-xs text-slate-300 whitespace-pre-wrap">${d.raw || JSON.stringify(d, null, 2)}</pre>`;
      fb.classList.remove('hidden');
      document.getElementById('aiSummary').classList.remove('hidden');
      return;
    }

    // Populate summary card
    const verdict = (s.verdict || 'MONITOR').toUpperCase();
    const verdictEl = document.getElementById('aiVerdict');
    verdictEl.textContent = verdict;
    verdictEl.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ' +
      (VERDICT_STYLE[verdict] || VERDICT_STYLE['MONITOR']);

    document.getElementById('aiPF').textContent = s.pf_position ? `P-F position: ${s.pf_position}` : '';
    document.getElementById('aiSummaryText').textContent = s.summary || '';
    document.getElementById('aiNextStep').textContent = s.next_step || '';

    // Build formatted full analysis HTML
    const esc = t => (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const section = (label, html) =>
      `<div>
        <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">${label}</p>
        ${html}
      </div>`;

    let html = '';

    if (s.key_findings?.length) {
      const items = s.key_findings.map(f =>
        `<li class="flex gap-2"><span class="text-yellow-400 mt-0.5">â€º</span><span>${esc(f)}</span></li>`
      ).join('');
      html += section(LANG==='da' ? 'NÃ¸glefund' : 'Key Findings',
        `<ul class="space-y-1 text-sm text-slate-200">${items}</ul>`);
    }

    if (s.root_cause) {
      html += section(LANG==='da' ? 'GrundÃ¥rsag' : 'Root Cause',
        `<p class="text-sm text-slate-200">${esc(s.root_cause)}</p>`);
    }

    if (s.recommended_actions) {
      const ra = s.recommended_actions;
      const rows = [
        ra.immediate      ? `<div class="flex gap-2"><span class="text-red-400 font-semibold w-28 shrink-0 text-xs pt-0.5">${LANG==='da'?'Straks':'Immediate'}</span><span class="text-sm text-slate-200">${esc(ra.immediate)}</span></div>` : '',
        ra.within_7_days  ? `<div class="flex gap-2"><span class="text-orange-400 font-semibold w-28 shrink-0 text-xs pt-0.5">${LANG==='da'?'Inden 7 dage':'Within 7 days'}</span><span class="text-sm text-slate-200">${esc(ra.within_7_days)}</span></div>` : '',
        ra.scheduled      ? `<div class="flex gap-2"><span class="text-green-400 font-semibold w-28 shrink-0 text-xs pt-0.5">${LANG==='da'?'Planlagt':'Scheduled'}</span><span class="text-sm text-slate-200">${esc(ra.scheduled)}</span></div>` : '',
      ].filter(Boolean).join('');
      html += section(LANG==='da' ? 'Anbefalede handlinger' : 'Recommended Actions',
        `<div class="space-y-2">${rows}</div>`);
    }

    if (s.risk_if_ignored) {
      html += section(LANG==='da' ? 'Risiko ved ingen handling' : 'Risk if Ignored',
        `<p class="text-sm text-red-300">${esc(s.risk_if_ignored)}</p>`);
    }

    const fullEl = document.getElementById('aiFullAnalysis');
    fullEl.innerHTML = `<div class="space-y-4">${html}</div>`;

    document.getElementById('aiSummary').classList.remove('hidden');
  } catch(e) {
    document.getElementById('aiLoading').classList.add('hidden');
    document.getElementById('aiError').textContent = `Error: ${e.message}`;
    document.getElementById('aiError').classList.remove('hidden');
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadLiveData();
loadPowerWindChart('24h');
loadTempChart('24h');
loadVibrationChart('24h');
loadRpmPitchChart('24h');
initTurbineMap({{ turbine.latitude }}, {{ turbine.longitude }});

setInterval(loadLiveData, 60000);
</script>
{% endblock %}
