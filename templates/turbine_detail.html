{% extends "base.html" %}
{% block title %}Wind Monitor ¬∑ {{ turbine.name }}{% endblock %}

{% block head_extra %}
<script>
  window.GOOGLE_MAPS_KEY = "{{ google_maps_key }}";
</script>
<style>
  /* Chart expand / full-width */
  .chart-card.expanded {
    position: relative;
    z-index: 10;
    grid-column: 1 / -1;   /* span full grid width */
  }
  .chart-card.expanded .chart-wrap {
    height: 380px !important;
  }
  #chartsGrid:has(.expanded) {
    grid-template-columns: 1fr !important; /* collapse grid to single col when one is expanded */
  }
</style>
{% endblock %}

{% block content %}
<!-- ‚îÄ‚îÄ Back + Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex flex-wrap items-center gap-3 mb-4">
  <a href="{{ url_for('dashboard') }}" class="flex items-center gap-1 text-slate-400 hover:text-white text-sm transition-colors">
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    {% if lang=='da' %}Tilbage{% else %}Back{% endif %}
  </a>
  <div class="flex-1">
    <div class="flex flex-wrap items-center gap-3">
      <h1 class="text-xl font-bold text-white" id="turbineName">{{ turbine.name }}</h1>
      <span id="statusBadgeEl" class="px-2.5 py-0.5 rounded-full text-xs font-semibold badge-{{ turbine.status }}">{{ turbine.status }}</span>
      <span id="sensorModeBadgeDetail" class="text-xs px-2 py-0.5 rounded-full font-medium"></span>
    </div>
    <div class="text-sm text-slate-400 mt-0.5">{{ turbine.make }} {{ turbine.model }} ¬∑ {{ turbine.serial_number }}</div>
  </div>
  <!-- AI Analyze button (stub) -->
  <button onclick="runAiAnalysis()" class="flex items-center gap-2 px-4 py-2 bg-violet-700 hover:bg-violet-600 text-white text-sm rounded-lg transition-colors">
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17H4a2 2 0 01-2-2V5a2 2 0 012-2h16a2 2 0 012 2v10a2 2 0 01-2 2h-1"/></svg>
    {% if lang=='da' %}AI Analyse{% else %}AI Analysis{% endif %}
  </button>
</div>

<!-- ‚îÄ‚îÄ Info Row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3 mb-4 text-sm">
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}M√¶rkeeffekt{% else %}Rated Power{% endif %}</div>
    <div class="font-semibold text-sky-300">{{ turbine.rated_power_kw|int }} kW</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}Navh√∏jde{% else %}Hub Height{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.hub_height_m|int }} m</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}Rotordiameter{% else %}Rotor Diameter{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.rotor_diameter_m|int }} m</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}Byggested{% else %}Build Date{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.build_date }}</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">{% if lang=='da' %}Seneste service{% else %}Last Service{% endif %}</div>
    <div class="font-semibold text-white">{{ turbine.last_service_date }}</div>
  </div>
  <div class="card p-3">
    <div class="text-xs text-slate-500 mb-1">GPS</div>
    <div class="font-semibold text-white text-xs">{{ "%.4f"|format(turbine.latitude) }}, {{ "%.4f"|format(turbine.longitude) }}</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Live Gauges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3 mb-4" id="gaugeRow">
  <!-- Power gauge ‚Äî EXTERNAL (X: turbine's own power meter, outside the monitoring box) -->
  <div class="sm:col-span-2 card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="external">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Effekt{% else %}Power Output{% endif %}</div>
    <canvas id="gaugePower" width="140" height="80"></canvas>
    <div id="valPower" class="text-xl font-bold text-sky-400 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">kW / {{ turbine.rated_power_kw|int }} kW</div>
  </div>
  <!-- Wind speed ‚Äî EXTERNAL (X: anemometer outside the box) -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="external">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Vind{% else %}Wind{% endif %}</div>
    <canvas id="gaugeWind" width="90" height="52"></canvas>
    <div id="valWind" class="text-lg font-bold text-emerald-400 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">m/s</div>
  </div>
  <!-- RPM ‚Äî EXTERNAL (X: rotor encoder on the turbine shaft) -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="external">
    <div class="text-xs text-slate-400 uppercase tracking-wide">RPM</div>
    <canvas id="gaugeRpm" width="90" height="52"></canvas>
    <div id="valRpm" class="text-lg font-bold text-purple-400 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">r/min</div>
  </div>
  <!-- Bearing Temp ‚Äî EXTERNAL (X: PT100 probe on bearing, outside the box) -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="external">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Lejetemperatur{% else %}Bearing Temp{% endif %}</div>
    <canvas id="gaugeBearingTemp" width="90" height="52"></canvas>
    <div id="valBearingTemp" class="text-lg font-bold text-orange-400 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">¬∞C</div>
  </div>
  <!-- Gearbox Temp ‚Äî EXTERNAL (X: PT100 probe on gearbox, outside the box) -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="external">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Gearkasse{% else %}Gearbox{% endif %}</div>
    <canvas id="gaugeGearboxTemp" width="90" height="52"></canvas>
    <div id="valGearboxTemp" class="text-lg font-bold text-orange-300 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">¬∞C</div>
  </div>
  <!-- Vibration X ‚Äî INTERNAL (O: accelerometer inside the monitoring box) -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="internal">
    <div class="text-xs text-slate-400 uppercase tracking-wide">Vibration X</div>
    <canvas id="gaugeVibX" width="90" height="52"></canvas>
    <div id="valVibX" class="text-lg font-bold text-red-400 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">g</div>
  </div>
  <!-- Acoustic ‚Äî INTERNAL (O: microphone inside the monitoring box) -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="internal">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Lydniveau{% else %}Acoustic{% endif %}</div>
    <canvas id="gaugeAcoustic" width="90" height="52"></canvas>
    <div id="valAcoustic" class="text-lg font-bold text-teal-400 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">dB</div>
  </div>
  <!-- Ambient Temp ‚Äî INTERNAL (O: ambient sensor inside the monitoring box) -->
  <div class="card px-4 pt-3 pb-4 flex flex-col items-center gap-1" data-sensor="internal">
    <div class="text-xs text-slate-400 uppercase tracking-wide">{% if lang=='da' %}Udetemperatur{% else %}Ambient Temp{% endif %}</div>
    <canvas id="gaugeAmbient" width="90" height="52"></canvas>
    <div id="valAmbient" class="text-lg font-bold text-cyan-400 -mt-1">‚Äî</div>
    <div class="text-xs text-slate-500">¬∞C</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Time-Series Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="chartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">

  <!-- Power + Wind ‚Äî EXTERNAL (both are X sensors outside the monitoring box) -->
  <div id="card-pw" class="card p-4 chart-card" data-sensor="external">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">{% if lang=='da' %}Effekt & Vindhastighed{% else %}Power Output & Wind Speed{% endif %}</h2>
      <div class="flex items-center gap-2 text-xs">
        <div class="flex gap-1">
          <button onclick="setRange('24h')" id="range-24h" class="range-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
          <button onclick="setRange('7d')"  id="range-7d"  class="range-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
          <button onclick="setRange('21d')" id="range-21d" class="range-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
        </div>
        <div class="w-px h-3 bg-slate-700"></div>
        <div id="res-pw" class="flex gap-1"></div>
        <button onclick="toggleExpand('card-pw', 'chartPowerWind')" class="expand-btn text-slate-400 hover:text-white p-0.5 rounded" title="Expand">
          <svg class="w-4 h-4 icon-expand" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/></svg>
          <svg class="w-4 h-4 icon-collapse hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"/></svg>
        </button>
      </div>
    </div>
    <div class="chart-wrap" style="height:200px;"><canvas id="chartPowerWind"></canvas></div>
  </div>

  <!-- Temperature ‚Äî EXTERNAL (bearing/gearbox are X sensors outside the box) -->
  <div id="card-temp" class="card p-4 chart-card" data-sensor="external">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">{% if lang=='da' %}Temperaturer{% else %}Temperatures{% endif %}</h2>
      <div class="flex items-center gap-2 text-xs">
        <div class="flex gap-1">
          <button onclick="setRange('24h')" id="range2-24h" class="range2-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
          <button onclick="setRange('7d')"  id="range2-7d"  class="range2-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
          <button onclick="setRange('21d')" id="range2-21d" class="range2-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
        </div>
        <div class="w-px h-3 bg-slate-700"></div>
        <div id="res-temp" class="flex gap-1"></div>
        <button onclick="toggleExpand('card-temp', 'chartTemps')" class="expand-btn text-slate-400 hover:text-white p-0.5 rounded" title="Expand">
          <svg class="w-4 h-4 icon-expand" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/></svg>
          <svg class="w-4 h-4 icon-collapse hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"/></svg>
        </button>
      </div>
    </div>
    <div class="chart-wrap" style="height:200px;"><canvas id="chartTemps"></canvas></div>
  </div>

  <!-- Vibration ‚Äî INTERNAL (O: accelerometer inside the monitoring box) -->
  <div id="card-vib" class="card p-4 chart-card" data-sensor="internal">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">{% if lang=='da' %}Vibration (gearkasse){% else %}Vibration (Gearbox){% endif %}</h2>
      <div class="flex items-center gap-2 text-xs">
        <div class="flex gap-1">
          <button onclick="setRange('24h')" id="range3-24h" class="range3-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
          <button onclick="setRange('7d')"  id="range3-7d"  class="range3-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
          <button onclick="setRange('21d')" id="range3-21d" class="range3-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
        </div>
        <div class="w-px h-3 bg-slate-700"></div>
        <div id="res-vib" class="flex gap-1"></div>
        <button onclick="toggleExpand('card-vib', 'chartVibration')" class="expand-btn text-slate-400 hover:text-white p-0.5 rounded" title="Expand">
          <svg class="w-4 h-4 icon-expand" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/></svg>
          <svg class="w-4 h-4 icon-collapse hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"/></svg>
        </button>
      </div>
    </div>
    <div class="chart-wrap" style="height:180px;"><canvas id="chartVibration"></canvas></div>
  </div>

  <!-- RPM + Pitch ‚Äî EXTERNAL (X: rotor encoder outside the monitoring box) -->
  <div id="card-rpm" class="card p-4 chart-card" data-sensor="external">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-white">RPM & {% if lang=='da' %}Pitch{% else %}Pitch Angle{% endif %}</h2>
      <div class="flex items-center gap-2 text-xs">
        <div class="flex gap-1">
          <button onclick="setRange('24h')" id="range4-24h" class="range4-btn px-2 py-0.5 rounded bg-sky-700 text-white">24h</button>
          <button onclick="setRange('7d')"  id="range4-7d"  class="range4-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">7d</button>
          <button onclick="setRange('21d')" id="range4-21d" class="range4-btn px-2 py-0.5 rounded text-slate-400 hover:text-white">21d</button>
        </div>
        <div class="w-px h-3 bg-slate-700"></div>
        <div id="res-rpm" class="flex gap-1"></div>
        <button onclick="toggleExpand('card-rpm', 'chartRpmPitch')" class="expand-btn text-slate-400 hover:text-white p-0.5 rounded" title="Expand">
          <svg class="w-4 h-4 icon-expand" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/></svg>
          <svg class="w-4 h-4 icon-collapse hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"/></svg>
        </button>
      </div>
    </div>
    <div class="chart-wrap" style="height:180px;"><canvas id="chartRpmPitch"></canvas></div>
  </div>

</div>

<!-- ‚îÄ‚îÄ Map + Events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
  <!-- Mini map -->
  <div class="card overflow-hidden" style="height:280px;">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 text-sm font-semibold text-white">
      {% if lang=='da' %}M√∏llens placering{% else %}Turbine Location{% endif %}
    </div>
    <div id="turbineMap" style="height:240px;"></div>
  </div>

  <!-- Event log -->
  <div class="card overflow-hidden" style="height:280px;">
    <div class="px-4 pt-3 pb-2 border-b border-slate-700 text-sm font-semibold text-white flex items-center justify-between">
      {% if lang=='da' %}H√¶ndelseslog{% else %}Event Log{% endif %}
      <span id="eventCount" class="text-xs text-slate-400"></span>
    </div>
    <div id="eventLog" class="overflow-y-auto" style="max-height:236px;"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ AI Analysis Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="aiModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
  <div class="card p-6 max-w-xl w-full">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-bold text-white text-lg">ü§ñ {% if lang=='da' %}AI Diagnose{% else %}AI Diagnostic{% endif %}</h2>
      <button onclick="document.getElementById('aiModal').classList.add('hidden')" class="text-slate-400 hover:text-white text-xl">‚úï</button>
    </div>

    <!-- Loading state -->
    <div id="aiLoading" class="text-sm text-slate-400 py-6 text-center">
      <div class="animate-pulse">{% if lang=='da' %}Analyserer sensordata...{% else %}Analyzing sensor data...{% endif %}</div>
    </div>

    <!-- Summary card (shown after load) -->
    <div id="aiSummary" class="hidden">
      <!-- Verdict badge -->
      <div class="flex items-center gap-3 mb-4">
        <span id="aiVerdict" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"></span>
        <span id="aiPF" class="text-xs text-slate-400"></span>
      </div>
      <!-- Summary sentence -->
      <p id="aiSummaryText" class="text-sm text-slate-200 leading-relaxed mb-3"></p>
      <!-- Next step highlight -->
      <div class="bg-blue-950/60 border border-blue-700/40 rounded-lg px-4 py-3 mb-4">
        <p class="text-xs text-blue-400 font-semibold uppercase tracking-wide mb-1">{% if lang=='da' %}Anbefalet n√¶ste skridt{% else %}Recommended Next Step{% endif %}</p>
        <p id="aiNextStep" class="text-sm text-white"></p>
      </div>
      <!-- Expand toggle -->
      <button id="aiExpandBtn" onclick="toggleFullAnalysis()"
        class="text-xs text-slate-400 hover:text-white underline underline-offset-2">
        {% if lang=='da' %}Vis fuld analyse ‚ñæ{% else %}Show full analysis ‚ñæ{% endif %}
      </button>
      <!-- Full analysis (collapsed by default) -->
      <div id="aiFullAnalysis" class="hidden mt-4 space-y-3 max-h-80 overflow-y-auto pr-1"></div>
    </div>

    <!-- Error state -->
    <div id="aiError" class="hidden text-sm text-red-400 py-4"></div>

    <p class="text-xs text-slate-500 mt-4" id="aiFooterNote">
      {% if lang=='da' %}Drevet af Claude ¬∑ Resultater logges i h√¶ndelseslog{% else %}Powered by Claude ¬∑ Results logged to event log{% endif %}
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ‚îÄ‚îÄ Global Chart.js: solid-circle legend + tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Chart.register({
  id: 'solidCircleLegend',
  beforeUpdate(chart) {
    // Force every dataset to use its borderColor as a solid fill in legends
    chart.data.datasets.forEach(ds => {
      const col = ds.borderColor || ds.backgroundColor;
      if (col && typeof col === 'string') {
        ds.pointStyle = 'circle';
        ds.pointBackgroundColor = col;
        ds.pointBorderColor = col;
      }
    });
  }
});

const TURBINE_ID = {{ turbine.id }};
const RATED_KW   = {{ turbine.rated_power_kw }};

// ‚îÄ‚îÄ Gauge Drawing (Canvas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawGauge(canvasId, value, max, color, thresholds) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const cx = w / 2, cy = h * 0.78;
  const r  = Math.min(w, h) * 0.65;
  const startAngle = Math.PI, endAngle = 2 * Math.PI;
  const pct = Math.min(1, Math.max(0, value / max));

  // Background arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, endAngle);
  ctx.lineWidth = 10;
  ctx.strokeStyle = '#334155';
  ctx.lineCap = 'round';
  ctx.stroke();

  // Determine color from thresholds
  let arcColor = color;
  if (thresholds) {
    if (value >= thresholds.critical) arcColor = '#ef4444';
    else if (value >= thresholds.warning) arcColor = '#f59e0b';
  }

  // Value arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, startAngle + pct * Math.PI);
  ctx.lineWidth = 10;
  ctx.strokeStyle = arcColor;
  ctx.lineCap = 'round';
  ctx.stroke();

  // Needle
  const angle = Math.PI + pct * Math.PI;
  const nx = cx + (r * 0.75) * Math.cos(angle);
  const ny = cy + (r * 0.75) * Math.sin(angle);
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(nx, ny);
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#e2e8f0';
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(cx, cy, 4, 0, 2 * Math.PI);
  ctx.fillStyle = '#e2e8f0';
  ctx.fill();
}

// ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Build chart options with correct x-axis time unit per range
function chartOpts(range, extraScales) {
  const unit = range === '24h' ? 'hour' : (range === '7d' ? 'day' : 'day');
  const maxTicks = range === '24h' ? 8 : (range === '7d' ? 7 : 7);
  const fmt = range === '24h'
    ? { hour: 'HH:mm', minute: 'HH:mm' }
    : { day: 'd MMM', hour: 'HH:mm' };
  const base = {
    responsive: true, maintainAspectRatio: false,
    animation: { duration: 300 },
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          color: '#94a3b8',
          font: { size: 11 },
          padding: 18,
          usePointStyle: true,
          pointStyle: 'circle',
          boxWidth: 6,
          boxHeight: 6,
          generateLabels(chart) {
            return Chart.defaults.plugins.legend.labels.generateLabels(chart).map(item => {
              // Force solid fill using the dataset's border/background colour
              const ds = chart.data.datasets[item.datasetIndex];
              const col = (typeof ds.borderColor === 'string' ? ds.borderColor : null)
                       || (typeof ds.backgroundColor === 'string' ? ds.backgroundColor : null)
                       || item.fillStyle;
              item.fillStyle = col;
              item.strokeStyle = col;
              item.lineWidth = 0;
              item.pointStyle = 'circle';
              return item;
            });
          }
        }
      },
      tooltip: {
        backgroundColor: 'rgba(15,23,42,0.95)',
        borderColor: '#334155',
        borderWidth: 1,
        titleColor: '#e2e8f0',
        titleFont: { weight: 'bold', size: 12 },
        bodyColor: '#94a3b8',
        bodyFont: { size: 12 },
        padding: 12,
        boxWidth: 8,
        boxHeight: 8,
        usePointStyle: true,
        pointStyle: 'circle',
        bodySpacing: 6,
        callbacks: {
          labelPointStyle: () => ({ pointStyle: 'circle', rotation: 0 }),
          labelColor(ctx) {
            const ds = ctx.chart.data.datasets[ctx.datasetIndex];
            const col = (typeof ds.borderColor === 'string' ? ds.borderColor : null)
                     || (typeof ds.backgroundColor === 'string' ? ds.backgroundColor : null)
                     || '#94a3b8';
            return { borderColor: col, backgroundColor: col, borderWidth: 0, borderRadius: 4 };
          }
        }
      }
    },
    scales: {
      x: { type: 'time', time: { unit, displayFormats: fmt }, grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#64748b', maxTicksLimit: maxTicks, font: { size: 10 } } },
      y: { grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#64748b', font: { size: 10 } } },
      ...(extraScales || {})
    }
  };
  return base;
}

let chartPW, chartT, chartV, chartRP;
let currentRange = '24h';

// Resolution options per range (minutes); default is first entry
const RES_OPTIONS = {
  '24h': [
    { val: 5,  label: '5m' },
    { val: 10, label: '10m' },
    { val: 15, label: '15m' },
  ],
  '7d': [
    { val: 360,  label: '6h' },
    { val: 720,  label: '12h' },
    { val: 1440, label: '24h' },
  ],
  '21d': [
    { val: 720,  label: '12h' },
    { val: 1440, label: '24h' },
    { val: 2880, label: '48h' },
  ],
};
let currentRes = { '24h': 5, '7d': 360, '21d': 720 };

async function fetchMetric(metric, range) {
  const res = currentRes[range] || 15;
  const r = await fetch(`/api/turbine/${TURBINE_ID}/chart?metric=${metric}&range=${range}&res=${res}`);
  return (await r.json()).data;
}

// Render resolution toggle buttons into a container element
function renderResBtns(containerId, range) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const opts = RES_OPTIONS[range] || [];
  el.innerHTML = opts.map(o =>
    `<button onclick="setRes(${o.val})"
       id="res-${containerId}-${o.val}"
       class="res-btn-${containerId} px-1.5 py-0.5 rounded text-slate-500 hover:text-white text-xs transition-colors ${currentRes[range]===o.val ? 'bg-slate-700 text-white' : ''}"
     >${o.label}</button>`
  ).join('');
}

function setRes(val) {
  currentRes[currentRange] = val;
  // Update button highlights across all 4 res containers
  ['res-pw','res-temp','res-vib','res-rpm'].forEach(cid => {
    const opts = RES_OPTIONS[currentRange] || [];
    opts.forEach(o => {
      const btn = document.getElementById(`res-${cid}-${o.val}`);
      if (btn) {
        btn.className = btn.className.replace(/bg-slate-700 text-white/, '').trim();
        if (o.val === val) btn.className += ' bg-slate-700 text-white';
      }
    });
  });
  // Reload all charts, then re-apply sensor mode
  Promise.all([
    loadPowerWindChart(currentRange),
    loadTempChart(currentRange),
    loadVibrationChart(currentRange),
    loadRpmPitchChart(currentRange),
  ]).then(() => applyDetailSensorMode(getSensorMode()));
}

// Helper: convert API data to {x, y} points, filtering nulls
function pts(data) {
  return data.filter(d => d.v !== null).map(d => ({ x: new Date(d.t), y: d.v }));
}

async function loadPowerWindChart(range) {
  const [pw, wd] = await Promise.all([fetchMetric('power_output_kw', range), fetchMetric('wind_speed_ms', range)]);
  const ctx = document.getElementById('chartPowerWind').getContext('2d');
  if (chartPW) chartPW.destroy();
  chartPW = new Chart(ctx, {
    data: {
      datasets: [
        { type:'bar',  label: LANG==='da'?'Effekt (kW)':'Power (kW)', data: pts(pw), backgroundColor:'rgba(14,165,233,0.35)', borderColor:'rgba(14,165,233,0.8)', borderWidth:1, borderRadius:1, yAxisID:'y' },
        { type:'line', label: LANG==='da'?'Vind (m/s)':'Wind (m/s)', data: pts(wd), borderColor:'rgba(52,211,153,0.8)', backgroundColor:'transparent', pointRadius:0, borderWidth:1.5, tension:0.3, yAxisID:'y2' },
      ]
    },
    options: chartOpts(range, { y:{ grid:{color:'rgba(51,65,85,0.5)'}, ticks:{color:'#64748b',font:{size:10}}, position:'left' }, y2:{ grid:{display:false}, ticks:{color:'#34d399',font:{size:10}}, position:'right' } })
  });
}

async function loadTempChart(range) {
  const [bt, gt, gen, ot] = await Promise.all([
    fetchMetric('bearing_temp_c', range),
    fetchMetric('gearbox_temp_c', range),
    fetchMetric('generator_temp_c', range),
    fetchMetric('oil_temp_c', range),
  ]);
  const ctx = document.getElementById('chartTemps').getContext('2d');
  if (chartT) chartT.destroy();
  chartT = new Chart(ctx, {
    type:'line',
    data: {
      datasets: [
        { label: LANG==='da'?'Leje':'Bearing',      data: pts(bt),  borderColor:'#f97316', pointRadius:0, borderWidth:1.5, tension:0.3 },
        { label: LANG==='da'?'Gearkasse':'Gearbox',  data: pts(gt),  borderColor:'#fb923c', pointRadius:0, borderWidth:1.5, tension:0.3 },
        { label: 'Generator',                         data: pts(gen), borderColor:'#fbbf24', pointRadius:0, borderWidth:1.5, tension:0.3 },
        { label: LANG==='da'?'Olie':'Oil',            data: pts(ot),  borderColor:'#a78bfa', pointRadius:0, borderWidth:1.5, tension:0.3 },
      ]
    },
    options: chartOpts(range)
  });
}

async function loadVibrationChart(range) {
  range = range || currentRange;
  const [vx, vy, vz] = await Promise.all([
    fetchMetric('vibration_gearbox_x', range),
    fetchMetric('vibration_gearbox_y', range),
    fetchMetric('vibration_gearbox_z', range),
  ]);
  const ctx = document.getElementById('chartVibration').getContext('2d');
  if (chartV) chartV.destroy();
  const opts = chartOpts(range);
  opts.plugins.annotation = { annotations: { threshold: { type:'line', yMin:0.5, yMax:0.5, borderColor:'rgba(239,68,68,0.5)', borderWidth:1, borderDash:[6,4], label:{content:LANG==='da'?'Gr√¶nse':'Limit',enabled:true,color:'#ef4444',font:{size:9}} } } };
  chartV = new Chart(ctx, {
    type:'line',
    data: {
      datasets: [
        { label:'X', data: pts(vx), borderColor:'#ef4444', pointRadius:0, borderWidth:1.5, tension:0.3 },
        { label:'Y', data: pts(vy), borderColor:'#a855f7', pointRadius:0, borderWidth:1.5, tension:0.3 },
        { label:'Z', data: pts(vz), borderColor:'#3b82f6', pointRadius:0, borderWidth:1.5, tension:0.3 },
      ]
    },
    options: opts
  });
}

async function loadRpmPitchChart(range) {
  range = range || currentRange;
  const [rpm, pitch] = await Promise.all([
    fetchMetric('rotor_rpm', range),
    fetchMetric('pitch_angle_deg', range),
  ]);
  const ctx = document.getElementById('chartRpmPitch').getContext('2d');
  if (chartRP) chartRP.destroy();
  chartRP = new Chart(ctx, {
    data: {
      datasets: [
        { type:'line', label:'RPM',   data: pts(rpm),   borderColor:'#a855f7', backgroundColor:'transparent', pointRadius:0, borderWidth:1.5, tension:0.3, yAxisID:'y' },
        { type:'line', label: LANG==='da'?'Pitch (¬∞)':'Pitch (¬∞)', data: pts(pitch), borderColor:'#06b6d4', backgroundColor:'transparent', pointRadius:0, borderWidth:1.5, tension:0.3, yAxisID:'y2' },
      ]
    },
    options: chartOpts(range, { y:{ grid:{color:'rgba(51,65,85,0.5)'}, ticks:{color:'#64748b',font:{size:10}}, position:'left' }, y2:{ grid:{display:false}, ticks:{color:'#06b6d4',font:{size:10}}, position:'right' } })
  });
}

// ‚îÄ‚îÄ Chart expand / collapse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHART_RELOAD = {
  'card-pw':   () => loadPowerWindChart(currentRange),
  'card-temp': () => loadTempChart(currentRange),
  'card-vib':  () => loadVibrationChart(currentRange),
  'card-rpm':  () => loadRpmPitchChart(currentRange),
};

function toggleExpand(cardId, canvasId) {
  const card = document.getElementById(cardId);
  const isExpanded = card.classList.contains('expanded');

  // Collapse any other expanded card first
  document.querySelectorAll('.chart-card.expanded').forEach(c => {
    if (c.id !== cardId) {
      c.classList.remove('expanded');
      c.querySelector('.icon-expand').classList.remove('hidden');
      c.querySelector('.icon-collapse').classList.add('hidden');
    }
  });

  if (isExpanded) {
    card.classList.remove('expanded');
    card.querySelector('.icon-expand').classList.remove('hidden');
    card.querySelector('.icon-collapse').classList.add('hidden');
  } else {
    card.classList.add('expanded');
    card.querySelector('.icon-expand').classList.add('hidden');
    card.querySelector('.icon-collapse').classList.remove('hidden');
  }

  // Reload chart so it redraws at the new size, then re-apply sensor mode
  setTimeout(() => {
    if (CHART_RELOAD[cardId]) CHART_RELOAD[cardId]().then(() => applyDetailSensorMode(getSensorMode()));
  }, 50);
}

// Single unified range setter ‚Äî updates all 4 charts and all 4 button groups
function setRange(r) {
  currentRange = r;
  // Reset resolution to default for this range
  const defaults = { '24h': 5, '7d': 360, '21d': 720 };
  currentRes[r] = defaults[r];

  [['range-btn','range'], ['range2-btn','range2'], ['range3-btn','range3'], ['range4-btn','range4']].forEach(([cls, prefix]) => {
    document.querySelectorAll('.'+cls).forEach(b => b.className = cls+' px-2 py-0.5 rounded text-slate-400 hover:text-white');
    const btn = document.getElementById(prefix+'-'+r);
    if (btn) btn.className = cls+' px-2 py-0.5 rounded bg-sky-700 text-white';
  });

  // Re-render resolution buttons for new range
  ['res-pw','res-temp','res-vib','res-rpm'].forEach(cid => renderResBtns(cid, r));

  Promise.all([
    loadPowerWindChart(r),
    loadTempChart(r),
    loadVibrationChart(r),
    loadRpmPitchChart(r),
  ]).then(() => applyDetailSensorMode(getSensorMode()));
}

// ‚îÄ‚îÄ Live Data & Gauges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLiveData() {
  const r = await fetch(`/api/turbine/${TURBINE_ID}`);
  const d = await r.json();
  if (!d.latest) return;
  const lt = d.latest;

  document.getElementById('valPower').textContent        = lt.power_kw    != null ? Math.round(lt.power_kw) : '‚Äî';
  document.getElementById('valWind').textContent         = lt.wind_ms     != null ? lt.wind_ms.toFixed(1) : '‚Äî';
  document.getElementById('valRpm').textContent          = lt.rpm         != null ? lt.rpm.toFixed(1) : '‚Äî';
  document.getElementById('valBearingTemp').textContent  = lt.bearing_temp!= null ? lt.bearing_temp.toFixed(0) : '‚Äî';
  document.getElementById('valGearboxTemp').textContent  = lt.gearbox_temp!= null ? lt.gearbox_temp.toFixed(0) : '‚Äî';
  document.getElementById('valVibX').textContent         = lt.vib_x       != null ? lt.vib_x.toFixed(3) : '‚Äî';
  document.getElementById('valAcoustic').textContent     = lt.acoustic_db  != null ? lt.acoustic_db.toFixed(0) : '‚Äî';
  document.getElementById('valAmbient').textContent      = lt.ambient_temp != null ? lt.ambient_temp.toFixed(0) : '‚Äî';

  drawGauge('gaugePower',       lt.power_kw     || 0, RATED_KW, '#0ea5e9', null);
  drawGauge('gaugeWind',        lt.wind_ms      || 0, 25,       '#34d399', null);
  drawGauge('gaugeRpm',         lt.rpm          || 0, 20,       '#a855f7', null);
  drawGauge('gaugeBearingTemp', lt.bearing_temp || 0, 100,      '#f97316', {warning:70,  critical:85});
  drawGauge('gaugeGearboxTemp', lt.gearbox_temp || 0, 100,      '#fb923c', {warning:75,  critical:90});
  drawGauge('gaugeVibX',        lt.vib_x        || 0, 1.0,      '#ef4444', {warning:0.3, critical:0.5});
  drawGauge('gaugeAcoustic',    lt.acoustic_db  || 0, 100,      '#2dd4bf', null);
  drawGauge('gaugeAmbient',     lt.ambient_temp || 0, 40,       '#22d3ee', null);

  // Render events
  renderEvents(d.events);
  document.getElementById('eventCount').textContent = `${d.events.filter(e=>!e.resolved).length} ${LANG==='da'?'√•bne':'open'}`;
}

function renderEvents(events) {
  const el = document.getElementById('eventLog');
  if (!events.length) { el.innerHTML = `<div class="px-4 py-4 text-slate-500 text-sm">${LANG==='da'?'Ingen h√¶ndelser':'No events'}</div>`; return; }
  const sevCol  = { critical:'text-red-400', fault:'text-red-300', warning:'text-amber-300', info:'text-sky-300' };
  const sevIcon = { critical:'üî¥', fault:'üî¥', warning:'üü°', info:'üîµ' };
  const isAI = e => e.category === 'AI Analysis';
  el.innerHTML = events.map(e => {
    const statusBadge = isAI(e)
      ? `<span class="text-xs px-1.5 py-0.5 rounded bg-violet-900/40 text-violet-400">ü§ñ ${LANG==='da'?'AI-analyse':'AI Analysis'}</span>`
      : e.resolved
        ? `<span class="text-xs px-1.5 py-0.5 rounded bg-green-900/40 text-green-400">${LANG==='da'?'L√∏st':'Resolved'}</span>`
        : `<span class="text-xs px-1.5 py-0.5 rounded bg-amber-900/40 text-amber-400">${LANG==='da'?'√Öben':'Open'}</span>`;
    return `<div class="px-4 py-3 border-b border-slate-800 hover:bg-slate-700/30 transition-colors">
      <div class="flex items-start gap-2">
        <span class="text-sm mt-0.5">${isAI(e) ? 'ü§ñ' : (sevIcon[e.severity]||'‚ö™')}</span>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-xs font-semibold ${sevCol[e.severity]||'text-slate-300'}">${e.friendly_code || e.code}</span>
            ${statusBadge}
          </div>
          <div class="text-xs text-slate-300 mt-1">${e.message}</div>
          ${e.ai_analysis ? `<details class="mt-1.5"><summary class="text-xs text-violet-400 cursor-pointer">ü§ñ ${LANG==='da'?'Vis fuld analyse':'View full analysis'}</summary><div class="text-xs text-slate-400 mt-1 p-2 bg-slate-900/50 rounded leading-relaxed">${e.ai_analysis}</div></details>` : ''}
          <div class="text-xs text-slate-600 mt-1">${new Date(e.ts).toLocaleString()}</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Mini Map (Google Maps) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TURBINE_SVG_PATH_DETAIL = "M36,58.09a7.11,7.11,0,0,1,.72.41l.12.07a6,6,0,0,1,1.43,1.36,5.84,5.84,0,0,1,.89,1.76v0a5.89,5.89,0,0,1,.23,2,7.59,7.59,0,0,1-.37,2l0,0a8,8,0,0,1-.41,1,9.31,9.31,0,0,1-.52.9A9.14,9.14,0,0,1,35,70.32,25.91,25.91,0,0,1,31.55,72c-9.5,3.9-18.87,8.6-28.37,12.4a3.14,3.14,0,0,1-1,.19h0a2.28,2.28,0,0,1-1.25-.32l-.37-.29a2,2,0,0,1-.34-.47l-.1-.24L0,83a1.78,1.78,0,0,1,0-.39v0a2.28,2.28,0,0,1,.47-1.31h0a4.09,4.09,0,0,1,.68-.72C9.51,73.62,18.3,67,26.81,60.23c.6-.48,1.22-.94,1.83-1.34a11.17,11.17,0,0,1,1.93-1l.13,0a6.55,6.55,0,0,1,2.11-.43,6.76,6.76,0,0,1,2.21.32l.1,0a7.33,7.33,0,0,1,.9.35ZM21.64,114.44H38.71l6.4-43.87a1.63,1.63,0,0,1,1.62-1.49h6a1.63,1.63,0,0,1,1.6,1.36l7.4,44H78.88a.89.89,0,0,1,.88.88V122a.89.89,0,0,1-.88.88H21.64a.88.88,0,0,1-.88-.88v-6.68a.88.88,0,0,1,.88-.88Zm32-66.07a9,9,0,0,1,2.87,1.91,8.73,8.73,0,0,1,2.57,6.1v.15a8.77,8.77,0,0,1-2.59,6.24,8.69,8.69,0,0,1-2.87,1.91A8.8,8.8,0,0,1,42.09,59.9a8.84,8.84,0,0,1,0-6.75A8.8,8.8,0,0,1,44,50.28h0a9.15,9.15,0,0,1,2.87-1.9,8.81,8.81,0,0,1,6.74,0Zm0-4.58a5.59,5.59,0,0,1-.8.45,5.82,5.82,0,0,1-1.94.54A5.54,5.54,0,0,1,49,44.63l-.09,0a6.23,6.23,0,0,1-1.8-.83,6.67,6.67,0,0,1-1.39-1.23l-.11-.12a7.71,7.71,0,0,1-.59-.81c-.17-.28-.34-.58-.49-.89l0,0c-1.2-2.54-.8-5.17-.4-7.85,1.8-10,2.25-20.76,4.06-30.76a3.45,3.45,0,0,1,.32-.88l0-.07a2.42,2.42,0,0,1,.85-.86l.06,0a1.69,1.69,0,0,1,.5-.18,1.75,1.75,0,0,1,.42,0A1.89,1.89,0,0,1,51,.13l.32.16a2.31,2.31,0,0,1,.88,1l.06.12a3.94,3.94,0,0,1,.28,1.09c1.76,10.18,2.74,21.75,4,32.13a2.2,2.2,0,0,1,0,.36h0c.08.7.15,1.39.17,2.07a11,11,0,0,1-.13,2.25v.07a6.83,6.83,0,0,1-.72,2,6.51,6.51,0,0,1-1.52,1.83,7.06,7.06,0,0,1-.78.57Zm7,21a7,7,0,0,1,0-.92,5.83,5.83,0,0,1,.5-2,5.43,5.43,0,0,1,1-1.54l.09-.09a6.08,6.08,0,0,1,1.61-1.14,7.46,7.46,0,0,1,1.78-.6l.14,0a7.57,7.57,0,0,1,1-.11,8.14,8.14,0,0,1,1,0h.07a9.28,9.28,0,0,1,3.92,1.33A27.18,27.18,0,0,1,74.93,62c8.12,6.31,16.34,12.51,24.52,18.76l.14.12a3.78,3.78,0,0,1,.61.78,2.44,2.44,0,0,1,.32,1.15l0,.26,0,.17a1.89,1.89,0,0,1-.24.6,2.05,2.05,0,0,1-.39.44l-.14.1a1.75,1.75,0,0,1-.27.16,2.51,2.51,0,0,1-1.36.2,4,4,0,0,1-1-.26L67,71.84c-.7-.29-1.4-.61-2.07-1A11.37,11.37,0,0,1,63,69.63l-.05,0a6.48,6.48,0,0,1-2.22-3.83,6.12,6.12,0,0,1-.11-1Z";

// Auth failure handler for detail page
window.gm_authFailure = function() {
  console.error('[Maps] Auth failure ‚Äî check API key and HTTP referrer restrictions');
  const el = document.getElementById('turbineMap');
  if (el) el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:13px;flex-direction:column;gap:8px"><span style="font-size:24px">üó∫Ô∏è</span><span>Map unavailable ‚Äî check API key</span></div>';
};

async function initTurbineMap(lat, lng) {
  // Bootstrap Google Maps using importLibrary pattern (v=weekly, no callback conflict)
  (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;a.onerror=()=>n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a);d[q]=f}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
  ({key: window.GOOGLE_MAPS_KEY, v: "weekly"});

  try {
    const { Map } = await google.maps.importLibrary('maps');
    const { AdvancedMarkerElement } = await google.maps.importLibrary('marker');

    const m = new Map(document.getElementById('turbineMap'), {
      center: { lat, lng },
      zoom: 13,
      mapId: 'DEMO_MAP_ID',
      colorScheme: 'DARK',
      mapTypeId: 'roadmap',
      zoomControl: true,
      streetViewControl: false,
      mapTypeControl: false,
      fullscreenControl: false,
    });

    const markerEl = document.createElement('div');
    markerEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100.52 122.88" width="40" height="49" fill="#38bdf8"><path d="${TURBINE_SVG_PATH_DETAIL}"/></svg>`;
    new AdvancedMarkerElement({ map: m, position: { lat, lng }, content: markerEl });
  } catch(err) {
    console.error('[Maps] Detail map init failed:', err);
    const el = document.getElementById('turbineMap');
    if (el) el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:13px;flex-direction:column;gap:8px"><span style="font-size:24px">üó∫Ô∏è</span><span>Map unavailable</span></div>';
  }
}

// ‚îÄ‚îÄ AI Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VERDICT_STYLE = {
  'OK':               'bg-green-900/60 text-green-300 border border-green-700/50',
  'MONITOR':          'bg-yellow-900/60 text-yellow-300 border border-yellow-700/50',
  'ACTION REQUIRED':  'bg-orange-900/60 text-orange-300 border border-orange-700/50',
  'CRITICAL':         'bg-red-900/60 text-red-300 border border-red-700/50',
};

function toggleFullAnalysis() {
  const el = document.getElementById('aiFullAnalysis');
  const btn = document.getElementById('aiExpandBtn');
  const hidden = el.classList.toggle('hidden');
  btn.textContent = hidden
    ? (LANG==='da' ? 'Vis fuld analyse ‚ñæ' : 'Show full analysis ‚ñæ')
    : (LANG==='da' ? 'Skjul fuld analyse ‚ñ¥' : 'Hide full analysis ‚ñ¥');
}

async function runAiAnalysis() {
  // Reset modal state
  document.getElementById('aiModal').classList.remove('hidden');
  document.getElementById('aiLoading').classList.remove('hidden');
  document.getElementById('aiSummary').classList.add('hidden');
  document.getElementById('aiError').classList.add('hidden');
  document.getElementById('aiFullAnalysis').classList.add('hidden');

  try {
    const r = await fetch(`/api/ai/analyze/${TURBINE_ID}`, { method:'POST' });
    const d = await r.json();

    document.getElementById('aiLoading').classList.add('hidden');

    if (d.status === 'stub') {
      document.getElementById('aiError').textContent = LANG==='da'
        ? 'AI-integration ikke konfigureret. Tilf√∏j ANTHROPIC_API_KEY i milj√∏variablerne.'
        : 'AI not configured. Add ANTHROPIC_API_KEY environment variable.';
      document.getElementById('aiError').classList.remove('hidden');
      return;
    }

    if (d.status === 'error') {
      document.getElementById('aiError').textContent = `Error: ${d.message}`;
      document.getElementById('aiError').classList.remove('hidden');
      return;
    }

    const s = d.structured;
    if (!s) {
      // Fallback: no structured parse, show raw
      const fb = document.getElementById('aiFullAnalysis');
      fb.innerHTML = `<pre class="text-xs text-slate-300 whitespace-pre-wrap">${d.raw || JSON.stringify(d, null, 2)}</pre>`;
      fb.classList.remove('hidden');
      document.getElementById('aiSummary').classList.remove('hidden');
      return;
    }

    // Populate summary card
    const verdict = (s.verdict || 'MONITOR').toUpperCase();
    const verdictEl = document.getElementById('aiVerdict');
    verdictEl.textContent = verdict;
    verdictEl.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ' +
      (VERDICT_STYLE[verdict] || VERDICT_STYLE['MONITOR']);

    document.getElementById('aiPF').textContent = s.pf_position ? `P-F position: ${s.pf_position}` : '';
    document.getElementById('aiSummaryText').textContent = s.summary || '';
    document.getElementById('aiNextStep').textContent = s.next_step || '';

    // Build formatted full analysis HTML
    const esc = t => (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const section = (label, html) =>
      `<div>
        <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-1">${label}</p>
        ${html}
      </div>`;

    let html = '';

    if (s.key_findings?.length) {
      const items = s.key_findings.map(f =>
        `<li class="flex gap-2"><span class="text-yellow-400 mt-0.5">‚Ä∫</span><span>${esc(f)}</span></li>`
      ).join('');
      html += section(LANG==='da' ? 'N√∏glefund' : 'Key Findings',
        `<ul class="space-y-1 text-sm text-slate-200">${items}</ul>`);
    }

    if (s.root_cause) {
      html += section(LANG==='da' ? 'Grund√•rsag' : 'Root Cause',
        `<p class="text-sm text-slate-200">${esc(s.root_cause)}</p>`);
    }

    if (s.recommended_actions) {
      const ra = s.recommended_actions;
      const rows = [
        ra.immediate      ? `<div class="flex gap-2"><span class="text-red-400 font-semibold w-28 shrink-0 text-xs pt-0.5">${LANG==='da'?'Straks':'Immediate'}</span><span class="text-sm text-slate-200">${esc(ra.immediate)}</span></div>` : '',
        ra.within_7_days  ? `<div class="flex gap-2"><span class="text-orange-400 font-semibold w-28 shrink-0 text-xs pt-0.5">${LANG==='da'?'Inden 7 dage':'Within 7 days'}</span><span class="text-sm text-slate-200">${esc(ra.within_7_days)}</span></div>` : '',
        ra.scheduled      ? `<div class="flex gap-2"><span class="text-green-400 font-semibold w-28 shrink-0 text-xs pt-0.5">${LANG==='da'?'Planlagt':'Scheduled'}</span><span class="text-sm text-slate-200">${esc(ra.scheduled)}</span></div>` : '',
      ].filter(Boolean).join('');
      html += section(LANG==='da' ? 'Anbefalede handlinger' : 'Recommended Actions',
        `<div class="space-y-2">${rows}</div>`);
    }

    if (s.risk_if_ignored) {
      html += section(LANG==='da' ? 'Risiko ved ingen handling' : 'Risk if Ignored',
        `<p class="text-sm text-red-300">${esc(s.risk_if_ignored)}</p>`);
    }

    const fullEl = document.getElementById('aiFullAnalysis');
    fullEl.innerHTML = `<div class="space-y-4">${html}</div>`;

    document.getElementById('aiSummary').classList.remove('hidden');

    // Surface db_error in footer if the event wasn't saved
    const footerNote = document.getElementById('aiFooterNote');
    if (d.db_error) {
      console.warn('[AI] Event not saved to DB:', d.db_error);
      footerNote.innerHTML = `<span class="text-amber-400">‚ö†Ô∏è ${LANG==='da'?'Resultat ikke gemt i DB':'Result not saved to DB'}: ${d.db_error.slice(0,120)}</span>`;
    } else if (d.event_id) {
      footerNote.innerHTML = LANG==='da'
        ? `Drevet af Claude ¬∑ Gemt i h√¶ndelseslog (ID&nbsp;${d.event_id})`
        : `Powered by Claude ¬∑ Saved to event log (ID&nbsp;${d.event_id})`;
    }

    // Reload live data so the new AI event appears in the event log
    loadLiveData();

  } catch(e) {
    document.getElementById('aiLoading').classList.add('hidden');
    document.getElementById('aiError').textContent = `Error: ${e.message}`;
    document.getElementById('aiError').classList.remove('hidden');
  }
}

// ‚îÄ‚îÄ Sensor Mode ‚Äî Detail Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Reads mode from localStorage (set by nav toggle in base.html).
// Gauges: hide elements whose data-sensor doesn't match mode.
// Charts: power+wind chart shows in all modes; temp/vib/rpm only in internal.
//         In external mode, show a wind-only view of the power+wind chart.

function applyDetailSensorMode(mode) {
  // 1) Gauges ‚Äî toggle visibility by data-sensor attribute
  document.querySelectorAll('#gaugeRow [data-sensor]').forEach(el => {
    const s = el.dataset.sensor;
    const visible = mode === 'all' || s === mode;
    el.style.display = visible ? '' : 'none';
  });

  // 2) Chart cards ‚Äî external: power/wind/temp/rpm charts; internal: vibration chart
  document.querySelectorAll('#chartsGrid .chart-card[data-sensor]').forEach(el => {
    const s = el.dataset.sensor;
    const visible = mode === 'all' || s === mode;
    el.style.display = visible ? '' : 'none';
  });

  // 3) Power+Wind chart: in 'all' mode show both datasets; no partial hiding needed
  //    (card-pw is data-sensor="external" so it hides entirely in internal mode)
  if (chartPW) {
    const [pwDS, windDS] = chartPW.data.datasets;
    // Always show both when the card is visible
    if (pwDS)   pwDS.hidden   = false;
    if (windDS) windDS.hidden = false;
    chartPW.update();
  }

  // 4) Update the mode indicator badge below the turbine name
  const badge = document.getElementById('sensorModeBadgeDetail');
  if (badge) {
    const cfg = {
      internal: { text: LANG==='da'?'üîß Interne sensorer':'üîß Internal sensors', cls:'bg-sky-900/50 text-sky-400 border border-sky-700/40' },
      external: { text: LANG==='da'?'üå§ Eksterne sensorer':'üå§ External sensors', cls:'bg-emerald-900/50 text-emerald-400 border border-emerald-700/40' },
      all:      { text: '', cls: '' },
    };
    const c = cfg[mode] || cfg.all;
    badge.textContent  = c.text;
    badge.className    = `text-xs px-2 py-0.5 rounded-full font-medium ${c.cls}`;
  }
}

window.addEventListener('sensorModeChange', (e) => {
  applyDetailSensorMode(e.detail.mode);
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadLiveData();
// Render initial resolution buttons for 24h
['res-pw','res-temp','res-vib','res-rpm'].forEach(cid => renderResBtns(cid, '24h'));

// Apply sensor mode to gauges immediately (before charts load)
applyDetailSensorMode(getSensorMode());

// Load charts, then re-apply mode so dataset visibility is set correctly
Promise.all([
  loadPowerWindChart('24h'),
  loadTempChart('24h'),
  loadVibrationChart('24h'),
  loadRpmPitchChart('24h'),
]).then(() => applyDetailSensorMode(getSensorMode()));

initTurbineMap({{ turbine.latitude }}, {{ turbine.longitude }});

setInterval(loadLiveData, 60000);
</script>
{% endblock %}
